<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Careem Clawback Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    /* Primary Colors - Modern Palette */
    --primary: #00695C;      /* Modern Teal */
    --primary-light: #26A69A; /* Light Teal */
    --primary-dark: #004D40;  /* Dark Teal */
    
    /* Secondary Colors */
    --secondary: #3949AB;    /* Modern Indigo */
    --secondary-light: #5C6BC0;
    --secondary-dark: #283593;
    
    /* Status Colors */
    --clawback: #E53935;     /* Modern Red */
    --penalty: #FB8C00;      /* Modern Orange */
    --compensated: #43A047;  /* Modern Green */
    --dispute: #8E24AA;      /* Modern Purple */
    
    /* Background Colors */
    --bg-light: #FAFAFA;     /* Very Light Gray */
    --bg-dark: #212121;      /* Dark Gray */
    --card-bg: #FFFFFF;      /* White */
    --card-bg-dark: #424242; /* Dark Card */
    
    /* Text Colors */
    --text-light: #212121;   /* Dark Gray */
    --text-dark: #F5F5F5;    /* Light Gray */
    --text-secondary: #757575; /* Medium Gray */
    
    /* Border and UI Elements */
    --border-color: #E0E0E0;
    --hover-bg: #E8F5E9;     /* Light Green Hover */
    --negative-color: #E53935;
    
    /* Shadows */
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
    
    /* Spacing */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
    --spacing-2xl: 48px;
    
    /* Border Radius */
    --radius-sm: 6px;
    --radius-md: 12px;
    --radius-lg: 16px;
    
    /* Transitions */
    --transition-fast: 0.2s;
    --transition-medium: 0.3s;
    --transition-slow: 0.5s;
  }

  body.dark-mode {
    --bg-light: #212121;
    --text-light: #F5F5F5;
    --card-bg: #424242;
    --border-color: #616161;
    --hover-bg: #424242;
    --text-secondary: #BDBDBD;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body { 
    font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; 
    margin: 0;
    padding: var(--spacing-md);
    background: var(--bg-light); 
    color: var(--text-light); 
    transition: background var(--transition-medium), color var(--transition-medium);
    line-height: 1.6;
  }

  .container { 
    max-width: 1400px; 
    margin: 0 auto; 
    padding: var(--spacing-md);
  }

  h2, h3 { 
    margin-bottom: var(--spacing-lg); 
    font-weight: 700;
    color: var(--primary);
    position: relative;
    padding-bottom: var(--spacing-sm);
  }

  h2::after, h3::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-light), var(--primary));
    border-radius: var(--radius-sm);
  }

  /* Modern Dashboard Cards */
  .dashboard { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: var(--spacing-lg); 
    margin-bottom: var(--spacing-2xl);
  }

  .dashboard-card { 
    background: var(--card-bg); 
    border-radius: var(--radius-lg); 
    padding: var(--spacing-xl); 
    box-shadow: var(--shadow-md); 
    text-align: center; 
    transition: all var(--transition-medium);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-light), var(--primary));
  }

  .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }

  .dashboard-card h4 { 
    margin: 0 0 var(--spacing-md); 
    font-size: 1em; 
    color: var(--primary-dark); 
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .dashboard-card p { 
    margin: 0; 
    font-size: 2.2em; 
    font-weight: 800;
    color: var(--text-light);
  }

  /* Category Cards */
  .category-card {
    border-left: 5px solid;
  }

  .category-card.clawback {
    border-left-color: var(--clawback);
  }

  .category-card.penalty {
    border-left-color: var(--penalty);
  }

  .category-card.compensated {
    border-left-color: var(--compensated);
  }

  .category-card.dispute {
    border-left-color: var(--dispute);
  }

  .category-card h4 {
    color: var(--primary);
  }

  .category-card.clawback h4 {
    color: var(--clawback);
  }

  .category-card.penalty h4 {
    color: var(--penalty);
  }

  .category-card.compensated h4 {
    color: var(--compensated);
  }

  .category-card.dispute h4 {
    color: var(--dispute);
  }

  /* Reasons Card */
  .reasons-card { 
    text-align: left; 
    max-height: 300px; 
    overflow-y: auto; 
    padding-right: var(--spacing-sm);
  }

  .reasons-card::-webkit-scrollbar {
    width: 8px;
  }

  .reasons-card::-webkit-scrollbar-track {
    background: var(--border-color);
    border-radius: var(--radius-sm);
  }

  .reasons-card::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: var(--radius-sm);
  }

  .reasons-card ul { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
  }

  .reasons-card li { 
    padding: var(--spacing-md) var(--spacing-lg); 
    border-bottom: 1px solid var(--border-color); 
    transition: all var(--transition-fast);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: var(--radius-sm);
    margin-bottom: var(--spacing-xs);
  }

  .reasons-card li:hover {
    background: var(--hover-bg);
    transform: translateX(5px);
  }

  .reasons-card li:last-child { 
    border-bottom: none; 
  }

  .reasons-card .reason { 
    font-weight: 700;
    color: var(--text-light);
  }

  .reasons-card .count {
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
    color: white;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-size: 0.85em;
    font-weight: 700;
  }

  .main-dispute {
    color: var(--dispute);
    font-weight: 800;
  }

  /* Tables */
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: var(--spacing-xl); 
    background: var(--card-bg); 
    border-radius: var(--radius-lg); 
    overflow: hidden; 
    box-shadow: var(--shadow-md);
  }

  th, td { 
    border: 1px solid var(--border-color); 
    padding: var(--spacing-md); 
    text-align: center; 
  }

  th { 
    background: linear-gradient(135deg, var(--hover-bg), var(--primary-light)); 
    cursor: pointer; 
    font-weight: 700;
    position: relative;
    user-select: none;
    color: white;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 1px;
  }

  th:hover { 
    background: linear-gradient(135deg, var(--primary-light), var(--primary)); 
  }

  th::after {
    content: '⇅';
    position: absolute;
    right: var(--spacing-md);
    opacity: 0.7;
  }

  th.sorted-asc::after {
    content: '↑';
    opacity: 1;
  }

  th.sorted-desc::after {
    content: '↓';
    opacity: 1;
  }

  .negative { 
    color: var(--negative-color); 
    font-weight: 800; 
  }

  /* Category Badges */
  .category-badge {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-size: 0.8em;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .category-badge.clawback {
    background: linear-gradient(135deg, var(--clawback), #D32F2F);
  }

  .category-badge.penalty {
    background: linear-gradient(135deg, var(--penalty), #F57C00);
  }

  .category-badge.compensated {
    background: linear-gradient(135deg, var(--compensated), #388E3C);
  }

  .category-badge.dispute {
    background: linear-gradient(135deg, var(--dispute), #7B1FA2);
  }

  .dispute-reason {
    color: var(--dispute);
    font-weight: 800;
  }

  /* Controls */
  .controls { 
    display: flex; 
    gap: var(--spacing-md); 
    flex-wrap: wrap; 
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-xl);
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    flex: 1;
    min-width: 200px;
  }

  .control-group label {
    font-weight: 700;
    font-size: 0.9em;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  input, textarea, select { 
    padding: var(--spacing-md); 
    border: 2px solid var(--border-color); 
    border-radius: var(--radius-md); 
    width: 100%; 
    box-sizing: border-box;
    transition: all var(--transition-fast);
    font-family: inherit;
    font-size: 1em;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 4px rgba(38, 166, 154, 0.2);
  }

  textarea { 
    resize: vertical; 
    min-height: 120px;
  }

  /* Buttons */
  button { 
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
    color: white; 
    border: none; 
    padding: var(--spacing-md) var(--spacing-lg); 
    cursor: pointer; 
    border-radius: var(--radius-md); 
    transition: all var(--transition-fast);
    font-weight: 700;
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: var(--shadow-sm);
  }

  button:active {
    transform: scale(0.96);
  }

  button:disabled { 
    background: #9E9E9E; 
    cursor: not-allowed; 
    opacity: 0.7;
  }

  button:hover:not(:disabled) { 
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .toggle-status-btn {
    background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)) !important;
    font-size: 0.8em !important;
    padding: 8px 16px !important;
    margin-right: var(--spacing-sm) !important;
  }

  .toggle-status-btn:hover:not(:disabled) { 
    background: linear-gradient(135deg, var(--secondary-light), var(--secondary)) !important;
  }

  /* Sections */
  .section { 
    margin-top: var(--spacing-2xl); 
    padding-top: var(--spacing-2xl); 
    border-top: 1px solid var(--border-color);
  }

  /* Notifications */
  .notification { 
    position: fixed; 
    top: var(--spacing-xl); 
    right: var(--spacing-xl); 
    padding: var(--spacing-md) var(--spacing-xl); 
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
    color: white; 
    border-radius: var(--radius-lg); 
    display: none; 
    z-index: 1000; 
    opacity: 0; 
    transition: opacity var(--transition-slow);
    box-shadow: var(--shadow-lg);
    max-width: 400px;
    font-weight: 600;
  }

  .notification.show { 
    opacity: 1; 
    display: block; 
  }

  .notification.error { 
    background: linear-gradient(135deg, var(--negative-color), #C62828); 
  }

  /* Stats Container */
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-2xl);
  }

  .stat-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    flex: 1;
    min-width: 200px;
    transition: all var(--transition-medium);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
    min-height: 140px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, var(--primary-light), var(--primary));
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
  }

  .stat-label {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  body.dark-mode .stat-label {
    color: #BDBDBD;
  }

  .stat-value {
    font-size: 2em;
    font-weight: 800;
    color: var(--primary);
  }

  /* Report Modal */
  .report-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow-y: auto;
    backdrop-filter: blur(8px);
  }

  .report-content {
    background-color: var(--card-bg);
    margin: 2% auto;
    padding: var(--spacing-2xl);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 1200px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: var(--shadow-lg);
  }

  .close {
    position: absolute;
    right: var(--spacing-xl);
    top: var(--spacing-xl);
    font-size: 36px;
    font-weight: bold;
    cursor: pointer;
    transition: color var(--transition-fast);
    color: var(--text-secondary);
  }

  .close:hover {
    color: var(--negative-color);
  }

  .report-header {
    text-align: center;
    margin-bottom: var(--spacing-2xl);
    padding-bottom: var(--spacing-xl);
    border-bottom: 2px solid var(--border-color);
  }

  .report-header h2 {
    color: var(--primary-dark);
    font-size: 2.2em;
    margin-bottom: var(--spacing-sm);
  }

  .report-section {
    margin-bottom: var(--spacing-2xl);
  }

  .report-section h3 {
    margin-bottom: var(--spacing-xl);
    color: var(--primary-dark);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: var(--spacing-sm);
    font-size: 1.5em;
  }

  .report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: var(--spacing-xl);
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .report-table th, .report-table td {
    padding: var(--spacing-md);
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .report-table th {
    background: linear-gradient(135deg, var(--hover-bg), var(--primary-light));
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 1px;
  }

  .report-table tr:last-child td {
    border-bottom: none;
  }

  .report-table tr:hover {
    background-color: var(--hover-bg);
  }

  .report-footer {
    text-align: center;
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 2px solid var(--border-color);
    font-size: 0.9em;
    color: var(--text-secondary);
  }

  body.dark-mode .report-footer {
    color: #BDBDBD;
  }

  /* Error Table */
  .error-table {
    margin-top: var(--spacing-xl);
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
  }

  .error-table th, .error-table td {
    padding: var(--spacing-md);
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .error-table th {
    background: linear-gradient(135deg, var(--hover-bg), var(--primary-light));
    font-weight: 700;
    color: white;
  }

  .error-reason {
    color: var(--negative-color);
    font-weight: 800;
  }

  .error-details {
    font-size: 0.9em;
    color: var(--text-secondary);
  }

  body.dark-mode .error-details {
    color: #BDBDBD;
  }

  .error-stats {
    display: flex;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
  }

  .error-stat {
    background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    flex: 1;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  body.dark-mode .error-stat {
    background: linear-gradient(135deg, #424242, #616161);
  }

  .error-stat-label {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
  }

  body.dark-mode .error-stat-label {
    color: #BDBDBD;
  }

  .error-stat-value {
    font-size: 1.8em;
    font-weight: 800;
    color: var(--negative-color);
  }

  /* Reason Filter */
  .reason-filter {
    position: relative;
  }

  .reason-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
    max-height: 250px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: var(--shadow-md);
  }

  .reason-option {
    padding: var(--spacing-sm) var(--spacing-md);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .reason-option:hover {
    background: var(--hover-bg);
  }

  .reason-option.selected {
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
    color: white;
  }

  /* Loading */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* File Upload */
  .file-upload {
    position: relative;
    display: inline-block;
    cursor: pointer;
    overflow: hidden;
  }

  .file-upload input[type=file] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .file-upload-label {
    display: block;
    padding: var(--spacing-md) var(--spacing-lg);
    background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
    color: white;
    border-radius: var(--radius-md);
    font-weight: 700;
    transition: all var(--transition-fast);
  }

  .file-upload:hover .file-upload-label {
    background: linear-gradient(135deg, var(--secondary-light), var(--secondary));
    transform: translateY(-2px);
  }

  /* Summary Section */
  .summary-section {
    background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
    border-radius: var(--radius-lg);
    padding: var(--spacing-2xl);
    margin-bottom: var(--spacing-2xl);
    box-shadow: var(--shadow-lg);
    color: white;
  }

  .summary-title {
    font-size: 1.6em;
    font-weight: 800;
    margin-bottom: var(--spacing-xl);
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-xl);
  }

  .summary-item {
    text-align: center;
    padding: var(--spacing-xl);
    border-radius: var(--radius-lg);
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    transition: all var(--transition-medium);
    min-height: 140px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .summary-item:hover {
    transform: translateY(-8px);
    background: rgba(255, 255, 255, 0.25);
  }

  .summary-label {
    font-size: 0.9em;
    margin-bottom: var(--spacing-sm);
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .summary-value {
    font-size: 2.2em;
    font-weight: 800;
  }

  .summary-item.clawback .summary-value {
    color: #FFCDD2;
  }

  .summary-item.penalty .summary-value {
    color: #FFE0B2;
  }

  .summary-item.compensated .summary-value {
    color: #C8E6C9;
  }

  .summary-item.dispute .summary-value {
    color: #E1BEE7;
  }

  .dispute-highlight {
    background-color: rgba(142, 36, 170, 0.1);
    border-left: 4px solid var(--dispute);
    padding-left: var(--spacing-md);
  }

  /* Analysis Cards */
  .analysis-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--spacing-2xl);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-md);
    border-left: 5px solid var(--primary-light);
  }

  .analysis-title {
    font-size: 1.3em;
    font-weight: 800;
    margin-bottom: var(--spacing-xl);
    color: var(--primary-dark);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: var(--spacing-sm);
  }

  .analysis-content {
    font-size: 1em;
    line-height: 1.8;
  }

  .analysis-content p {
    margin-bottom: var(--spacing-md);
  }

  .analysis-content ol, .analysis-content ul {
    margin-left: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
  }

  .analysis-content li {
    margin-bottom: var(--spacing-sm);
  }

  .highlight {
    background-color: rgba(76, 175, 80, 0.1);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-weight: 700;
  }

  .negative-highlight {
    background-color: rgba(229, 57, 53, 0.1);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-weight: 700;
    color: var(--negative-color);
  }

  /* Import Options */
  .import-options {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }

  .import-options h4 {
    margin-top: 0;
    margin-bottom: var(--spacing-lg);
    color: var(--primary-dark);
    font-size: 1.2em;
  }

  .radio-group {
    display: flex;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
  }

  .radio-option {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .radio-option input[type="radio"] {
    width: auto;
    margin: 0;
  }

  .date-range {
    display: flex;
    gap: var(--spacing-lg);
    align-items: center;
  }

  .date-range input {
    flex: 1;
  }

  /* Print Styles */
  @media print {
    body {
      background: white !important;
      color: black !important;
    }
    
    .container {
      max-width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .section {
      page-break-inside: avoid;
    }
    
    .dashboard-card, .stat-card, .analysis-card {
      box-shadow: none !important;
      border: 1px solid #ddd !important;
    }
    
    button, .controls, .file-upload {
      display: none !important;
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    body { 
      margin: var(--spacing-sm); 
      padding: var(--spacing-sm);
    }
    
    .container {
      padding: var(--spacing-sm);
    }
    
    table { 
      display: block; 
      overflow-x: auto; 
    }
    
    .controls { 
      flex-direction: column; 
    }
    
    .dashboard { 
      grid-template-columns: 1fr; 
    }
    
    .stats-container {
      flex-direction: column;
    }
    
    .report-content {
      width: 95%;
      margin: 5% auto;
      padding: var(--spacing-lg);
    }
    
    .stat-card {
      min-width: 100%;
    }
    
    .summary-grid {
      grid-template-columns: 1fr;
    }
    
    .radio-group {
      flex-direction: column;
      gap: var(--spacing-sm);
    }
    
    .date-range {
      flex-direction: column;
      gap: var(--spacing-sm);
    }
    
    .reasons-card {
      max-height: 200px;
    }
  }
</style>
</head>

<body>

<div class="container">
  <h2>Careem Clawback Tracker</h2>

  <div class="section">
    <h3>Import Data</h3>
    
    <div class="import-options">
      <h4>Import Options</h4>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="replaceData" name="importOption" value="replace" checked>
          <label for="replaceData">Replace all data</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="appendData" name="importOption" value="append">
          <label for="appendData">Append to existing data</label>
        </div>
      </div>
      
      <div class="date-range">
        <label for="dateFrom">From Date:</label>
        <input type="date" id="importDateFrom">
        <label for="dateTo">To Date:</label>
        <input type="date" id="importDateTo">
      </div>
    </div>
    
    <div class="control-group">
      <label for="rawData">Paste clawback data (tab or comma separated):</label>
      <textarea id="rawData" placeholder="REF123&#9;BILL456&#9;9/16/2025&#9;-50.00&#9;Food__Customer__Quality Issues__Food is overcooked/burnt&#9;Downtown Dubai"></textarea>
    </div>
    
    <div class="controls">
      <button onclick="importData()">Import Data</button>
      
      <div class="file-upload">
        <input type="file" id="csvFile" accept=".csv" onchange="importFromCSV()">
        <label for="csvFile" class="file-upload-label">Import from CSV</label>
      </div>
      
      <button onclick="exportToCSV()">Export to CSV</button>
      <button onclick="exportInvalidRecords()">Export Invalid Records</button>
      <button onclick="generateReport()">Generate Report</button>
      <button onclick="clearFilters()">Clear Filters</button>
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
      <button onclick="toggleReasonConsolidation()">Toggle Consolidated Reasons</button>
    </div>
  </div>

  <div class="section">
    <h3>Overall Summary</h3>
    <div class="summary-section">
      <div class="summary-title">Financial Overview</div>
      <div class="summary-grid">
        <div class="summary-item clawback">
          <div class="summary-label">Total Clawbacks</div>
          <div class="summary-value" id="totalClawbacks">0</div>
        </div>
        <div class="summary-item penalty">
          <div class="summary-label">Total Penalties</div>
          <div class="summary-value" id="totalPenalties">0</div>
        </div>
        <div class="summary-item compensated">
          <div class="summary-label">Total Compensated</div>
          <div class="summary-value" id="totalCompensated">0</div>
        </div>
        <div class="summary-item dispute">
          <div class="summary-label">Main Disputes</div>
          <div class="summary-value" id="totalDisputes">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Net Amount</div>
          <div class="summary-value" id="netAmount">0</div>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Dashboard</h3>
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">Total Records</div>
        <div class="stat-value" id="totalRecords">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Deductions</div>
        <div class="stat-value" id="totalDeductions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average per Record</div>
        <div class="stat-value" id="averageRecord">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Refunded Amount</div>
        <div class="stat-value" id="refundedAmount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Compensated Amount</div>
        <div class="stat-value" id="compensatedAmount">0</div>
      </div>
    </div>
    
    <div id="errorStats" class="error-stats" style="display: none;">
      <div class="error-stat">
        <div class="error-stat-label">Invalid Records</div>
        <div class="error-stat-value" id="invalidCount">0</div>
      </div>
      <div class="error-stat">
        <div class="error-stat-label">Duplicate Records</div>
        <div class="error-stat-value" id="duplicateCount">0</div>
      </div>
      <div class="error-stat">
        <div class="error-stat-label">Valid Records</div>
        <div class="error-stat-value" id="validCount">0</div>
      </div>
    </div>
    
    <div class="dashboard" id="reasonsBreakdown">
      <div class="dashboard-card reasons-card">
        <h4>Reasons Breakdown</h4>
        <ul id="reasonsList">
          <li>No data available</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="section" id="invalidRecordsSection" style="display: none;">
    <h3>Data Quality Issues</h3>
    <table class="error-table">
      <thead>
        <tr>
          <th>Line #</th>
          <th>Original Data</th>
          <th>Error Reason</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="invalidRecordsTable"></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Filters</h3>
    <div class="controls">
      <div class="control-group">
        <label for="filterRefId">Reference ID:</label>
        <input type="text" id="filterRefId" onkeyup="applyFilters()" placeholder="Filter by Reference ID">
      </div>
      
      <div class="control-group">
        <label for="filterId">Billable ID:</label>
        <input type="text" id="filterId" onkeyup="applyFilters()" placeholder="Filter by Billable ID">
      </div>
      
      <div class="control-group">
        <label for="filterArea">Merchant Area:</label>
        <input type="text" id="filterArea" onkeyup="applyFilters()" placeholder="Filter by Area">
      </div>
      
      <div class="control-group">
        <label for="filterStatus">Status:</label>
        <select id="filterStatus" onchange="applyFilters()">
          <option value="">All</option>
          <option value="Refunded">Refunded</option>
          <option value="COMPENSATED">COMPENSATED</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="filterCategory">Category:</label>
        <select id="filterCategory" onchange="applyFilters()">
          <option value="">All</option>
          <option value="CLAWBACK">Clawback</option>
          <option value="PENALTY">Penalty</option>
          <option value="COMPENSATED">Compensated</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="filterReason">Reason:</label>
        <div class="reason-filter">
          <input type="text" id="filterReason" placeholder="Select or type reason" readonly onclick="toggleReasonDropdown()">
          <div class="reason-dropdown" id="reasonDropdown"></div>
        </div>
      </div>
      
      <div class="control-group">
        <label for="filterDateFrom">From Date:</label>
        <input type="date" id="filterDateFrom" onchange="applyFilters()">
      </div>
      
      <div class="control-group">
        <label for="filterDateTo">To Date:</label>
        <input type="date" id="filterDateTo" onchange="applyFilters()">
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Transactions</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th onclick="sortTable('referenceId')">Reference ID</th>
          <th onclick="sortTable('id')">Billable ID</th>
          <th onclick="sortTable('date')">Date</th>
          <th onclick="sortTable('amount')">Amount</th>
          <th onclick="sortTable('description')">Description</th>
          <th onclick="sortTable('area')">Merchant Area</th>
          <th onclick="sortTable('category')">Category</th>
          <th onclick="sortTable('status')">Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Branch Summary (Orders and Reasons per Branch)</h3>
    <table id="branchTable">
      <thead>
        <tr>
          <th>Branch</th>
          <th>Order Count</th>
          <th>Total Deductions</th>
          <th>Reasons</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Comprehensive Analysis Report</h3>
    <div class="analysis-card">
      <div class="analysis-title">Executive Summary</div>
      <div class="analysis-content" id="executiveSummary">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Main Dispute Reasons Analysis</div>
      <div class="analysis-content" id="disputeAnalysis">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Financial Impact Analysis</div>
      <div class="analysis-content" id="financialAnalysis">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Branch Performance Analysis</div>
      <div class="analysis-content" id="branchAnalysis">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Strategic Recommendations</div>
      <div class="analysis-content" id="recommendations">
        No data available. Please import data to generate analysis.
      </div>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<!-- Report Modal -->
<div id="reportModal" class="report-modal">
  <div class="report-content" id="reportContent">
    <span class="close" onclick="closeReport()">&times;</span>
    <div class="report-header">
      <h2>Careem Clawback Management Report</h2>
      <p id="reportDate"></p>
    </div>
    <div class="report-section">
      <h3>Overall Financial Summary</h3>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">Total Clawbacks</div>
          <div class="stat-value" id="reportTotalClawbacks">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Penalties</div>
          <div class="stat-value" id="reportTotalPenalties">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Compensated</div>
          <div class="stat-value" id="reportTotalCompensated">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Main Disputes</div>
          <div class="stat-value" id="reportTotalDisputes">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Net Amount</div>
          <div class="stat-value" id="reportNetAmount">0</div>
        </div>
      </div>
    </div>
    <div class="report-section">
      <h3>Executive Summary</h3>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">Total Transactions</div>
          <div class="stat-value" id="reportTotalRecords">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Deductions</div>
          <div class="stat-value" id="reportTotalDeductions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average per Transaction</div>
          <div class="stat-value" id="reportAverageRecord">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Refunded Amount</div>
          <div class="stat-value" id="reportRefundedAmount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Compensated Amount</div>
          <div class="stat-value" id="reportCompensatedAmount">0</div>
        </div>
      </div>
    </div>
    <div class="report-section">
      <h3>Main Dispute Reasons (Careem Accepted Refunds)</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Reason</th>
            <th>Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="mainDisputesTable"></tbody>
      </table>
      <p style="margin-top: var(--spacing-md); font-style: italic;">
        Total main disputes: <span id="totalMainDisputesCount">0</span> (<span id="totalMainDisputesPercent">0</span>% of all transactions)
      </p>
    </div>
    <div class="report-section">
      <h3>Data Quality Summary</h3>
      <div id="reportDataQuality" class="stats-container"></div>
    </div>
    <div class="report-section">
      <h3>Top Reasons for Clawbacks</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Reason</th>
            <th>Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="topReasonsTable"></tbody>
      </table>
    </div>
    <div class="report-section">
      <h3>Top Branches by Deduction Amount</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Branch</th>
            <th>Total Deductions</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="topBranchesTable"></tbody>
      </table>
    </div>
    <div class="report-footer">
      <p>Generated by Careem Clawback Tracker on <span id="reportFooterDate"></span></p>
    </div>
    <div class="controls">
      <button onclick="printReport()">Print Report</button>
      <button onclick="exportToPDF()">Export as PDF</button>
    </div>
  </div>
</div>

<script>
// Global variables
let transactions = [];
let invalidRecords = [];
let duplicateRecords = [];
let sortColumn = null;
let sortAscending = true;
let consolidateReasons = false;
let reasonsList = [];
let selectedReason = "";
let isProcessing = false;

// Main dispute reasons that Careem accepts for refunds
const mainDisputeReasons = [
  "Spilled / damaged",
  "Missing or unavailable items",
  "Wrong item sent",
  "Partner Did not Prepare"
];

// Predefined reasons mapping in order
const predefinedReasons = [
  "Spilled / damaged",           // Main dispute reason
  "Missing or unavailable items", // Main dispute reason
  "Wrong item sent",             // Main dispute reason
  "Partner Did not Prepare",      // Main dispute reason
  "Food is overcooked/burnt",
  "Food is undercooked",
  "Hair in the food",
  "Foul Smell",
  "My Food is not edible (SelfServe)",
  "Instructions not followed",
  "Penalty for clawback complaint reason",
  "Penalties for Order",
  "Clawback Reversals",
  "Additional Penalty"
];

// Keywords for each predefined reason
const reasonKeywords = {
  "Spilled / damaged": ["spilled", "damaged", "spill", "damage", "broken", "leak", "leaked", "split", "cracked"],
  "Missing or unavailable items": ["missing", "unavailable", "out of stock", "not available", "item missing", "items missing"],
  "Wrong item sent": ["wrong item", "incorrect item", "wrong order", "incorrect order", "sent wrong", "delivered wrong"],
  "Partner Did not Prepare": ["did not prepare", "not prepared", "partner did not", "not ready", "preparation issue"],
  "Food is overcooked/burnt": ["overcooked", "burnt", "burned", "too cooked", "over done"],
  "Food is undercooked": ["undercooked", "raw", "not cooked", "under done", "too raw"],
  "Hair in the food": ["hair", "hair in", "found hair"],
  "Foul Smell": ["foul smell", "bad smell", "smell bad", "stinks", "odor"],
  "My Food is not edible (SelfServe)": ["not edible", "inedible", "can't eat", "not eatable"],
  "Instructions not followed": ["instructions not followed", "didn't follow", "not followed", "ignored instructions"],
  "Penalty for clawback complaint reason": ["penalty for clawback", "clawback penalty", "penalty complaint"],
  "Penalties for Order": ["penalties for order", "order penalty", "penalty order"],
  "Clawback Reversals": ["clawback reversal", "reversal", "reversed clawback"],
  "Additional Penalty": ["additional penalty", "extra penalty", "added penalty"]
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Set default dates to last 30 days
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);
  
  document.getElementById('importDateFrom').value = formatDateForInput(thirtyDaysAgo);
  document.getElementById('importDateTo').value = formatDateForInput(today);
  
  // Load data from localStorage if available
  const savedTransactions = localStorage.getItem('careemTransactions');
  if (savedTransactions) {
    try {
      transactions = JSON.parse(savedTransactions);
      updateDashboard();
      updateBranchTable();
      updateAnalysis();
      applyFilters();
    } catch (e) {
      console.error('Error loading saved data:', e);
      showNotification('Error loading saved data', true);
    }
  }
  
  // Initialize reason dropdown
  updateReasonsList();
  
  // Load dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
});

// Format date for input field
function formatDateForInput(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Parse date from string
function parseDate(dateString) {
  if (!dateString) return null;
  
  // Try different date formats
  const formats = [
    /(\d{1,2})\/(\d{1,2})\/(\d{4})/,  // MM/DD/YYYY
    /(\d{4})-(\d{1,2})-(\d{1,2})/,  // YYYY-MM-DD
    /(\d{1,2})-(\d{1,2})-(\d{4})/   // DD-MM-YYYY
  ];
  
  for (const format of formats) {
    const match = dateString.match(format);
    if (match) {
      let year, month, day;
      
      if (format === formats[0]) { // MM/DD/YYYY
        month = parseInt(match[1], 10);
        day = parseInt(match[2], 10);
        year = parseInt(match[3], 10);
      } else if (format === formats[1]) { // YYYY-MM-DD
        year = parseInt(match[1], 10);
        month = parseInt(match[2], 10);
        day = parseInt(match[3], 10);
      } else { // DD-MM-YYYY
        day = parseInt(match[1], 10);
        month = parseInt(match[2], 10);
        year = parseInt(match[3], 10);
      }
      
      // Create date object and check if valid
      const date = new Date(year, month - 1, day);
      if (!isNaN(date.getTime())) {
        return date;
      }
    }
  }
  
  return null;
}

// Format date for display
function formatDate(date) {
  if (!date) return '';
  
  const options = { year: 'numeric', month: 'short', day: 'numeric' };
  return date.toLocaleDateString(undefined, options);
}

// Parse transaction data from a line
function parseTransactionData(line, lineNumber) {
  const parts = line.split(/\t|,/);
  
  if (parts.length < 6) {
    return {
      error: `Invalid format: Expected at least 6 columns, got ${parts.length}`,
      details: `Line ${lineNumber}: ${line}`
    };
  }
  
  const referenceId = parts[0].trim();
  const id = parts[1].trim();
  const dateStr = parts[2].trim();
  const amountStr = parts[3].trim();
  const description = parts[4].trim();
  const area = parts[5].trim();
  
  // Validate required fields
  if (!referenceId || !id || !dateStr || !amountStr || !description) {
    return {
      error: 'Missing required fields',
      details: `Line ${lineNumber}: ${line}`
    };
  }
  
  // Parse date
  const date = parseDate(dateStr);
  if (!date) {
    return {
      error: 'Invalid date format',
      details: `Line ${lineNumber}: ${line}`
    };
  }
  
  // Parse amount
  let amount;
  try {
    amount = parseFloat(amountStr);
    if (isNaN(amount)) {
      return {
        error: 'Invalid amount format',
        details: `Line ${lineNumber}: ${line}`
      };
    }
  } catch (e) {
    return {
      error: 'Invalid amount format',
      details: `Line ${lineNumber}: ${line}`
    };
  }
  
  // Categorize transaction
  const categoryInfo = categorizeTransaction(description);
  
  return {
    referenceId,
    id,
    date: formatDateForInput(date),
    amount,
    description,
    area,
    category: categoryInfo.category,
    status: categoryInfo.status,
    isMainDispute: categoryInfo.isMainDispute,
    reason: categoryInfo.reason,
    lineNumber
  };
}

// Categorize transaction based on description
function categorizeTransaction(description) {
  const lowerDesc = description.toLowerCase();
  
  // Check if it's a main dispute reason
  for (const reason of mainDisputeReasons) {
    if (lowerDesc.includes(reason.toLowerCase())) {
      return {
        category: 'CLAWBACK',
        status: 'Refunded',
        isMainDispute: true,
        reason: reason
      };
    }
  }
  
  // Check for other predefined reasons
  for (const reason of predefinedReasons) {
    if (lowerDesc.includes(reason.toLowerCase())) {
      return {
        category: reason.includes('Penalty') ? 'PENALTY' : 'CLAWBACK',
        status: '',
        isMainDispute: false,
        reason: reason
      };
    }
  }
  
  // Check for keywords
  for (const [reason, keywords] of Object.entries(reasonKeywords)) {
    for (const keyword of keywords) {
      if (lowerDesc.includes(keyword)) {
        return {
          category: reason.includes('Penalty') ? 'PENALTY' : 'CLAWBACK',
          status: '',
          isMainDispute: false,
          reason: reason
        };
      }
    }
  }
  
  // Default categorization
  if (lowerDesc.includes('compensat') || lowerDesc.includes('reversal')) {
    return {
      category: 'COMPENSATED',
      status: 'Compensated',
      isMainDispute: false,
      reason: 'Compensation/Reversal'
    };
  }
  
  if (lowerDesc.includes('penalty')) {
    return {
      category: 'PENALTY',
      status: '',
      isMainDispute: false,
      reason: 'Penalty'
    };
  }
  
  // Default to clawback
  return {
    category: 'CLAWBACK',
    status: '',
    isMainDispute: false,
    reason: 'Other'
  };
}

// Import data from textarea
function importData() {
  if (isProcessing) return;
  
  const rawData = document.getElementById('rawData').value.trim();
  if (!rawData) {
    showNotification('Please enter data to import', true);
    return;
  }
  
  isProcessing = true;
  document.querySelector('button[onclick="importData()"]').innerHTML = '<span class="loading"></span> Processing...';
  
  // Get import options
  const importOption = document.querySelector('input[name="importOption"]:checked').value;
  const dateFrom = document.getElementById('importDateFrom').value;
  const dateTo = document.getElementById('importDateTo').value;
  
  // Process data
  const lines = rawData.split('\n');
  const newTransactions = [];
  const newInvalidRecords = [];
  const newDuplicateRecords = [];
  
  // Check for duplicates if appending
  const existingIds = importOption === 'append' ? 
    new Set(transactions.map(t => `${t.referenceId}-${t.id}`)) : new Set();
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    const result = parseTransactionData(line, i + 1);
    
    if (result.error) {
      newInvalidRecords.push({
        lineNumber: i + 1,
        originalData: line,
        errorReason: result.error,
        details: result.details
      });
      continue;
    }
    
    // Check date range if specified
    if (dateFrom && result.date < dateFrom) continue;
    if (dateTo && result.date > dateTo) continue;
    
    // Check for duplicates
    const idKey = `${result.referenceId}-${result.id}`;
    if (existingIds.has(idKey)) {
      newDuplicateRecords.push({
        lineNumber: i + 1,
        originalData: line,
        errorReason: 'Duplicate record',
        details: `Reference ID: ${result.referenceId}, Billable ID: ${result.id}`
      });
      continue;
    }
    
    existingIds.add(idKey);
    newTransactions.push(result);
  }
  
  // Update data based on import option
  if (importOption === 'replace') {
    transactions = newTransactions;
    invalidRecords = newInvalidRecords;
    duplicateRecords = newDuplicateRecords;
  } else {
    transactions = [...transactions, ...newTransactions];
    invalidRecords = [...invalidRecords, ...newInvalidRecords];
    duplicateRecords = [...duplicateRecords, ...newDuplicateRecords];
  }
  
  // Save to localStorage
  localStorage.setItem('careemTransactions', JSON.stringify(transactions));
  
  // Update UI
  updateDashboard();
  updateBranchTable();
  updateAnalysis();
  applyFilters();
  
  // Show notification
  const validCount = newTransactions.length;
  const invalidCount = newInvalidRecords.length;
  const duplicateCount = newDuplicateRecords.length;
  
  let message = `Successfully imported ${validCount} valid records`;
  if (invalidCount > 0) message += `, ${invalidCount} invalid records`;
  if (duplicateCount > 0) message += `, ${duplicateCount} duplicate records`;
  
  showNotification(message);
  
  // Reset processing state
  isProcessing = false;
  document.querySelector('button[onclick="importData()"]').innerHTML = 'Import Data';
  
  // Clear textarea
  document.getElementById('rawData').value = '';
}

// Import data from CSV file
function importFromCSV() {
  const fileInput = document.getElementById('csvFile');
  if (!fileInput.files.length) {
    showNotification('Please select a CSV file', true);
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const csvData = e.target.result;
    document.getElementById('rawData').value = csvData;
    importData();
    fileInput.value = ''; // Reset file input
  };
  
  reader.readAsText(file);
}

// Export data to CSV
function exportToCSV() {
  if (transactions.length === 0) {
    showNotification('No data to export', true);
    return;
  }
  
  // Create CSV content
  let csvContent = "Reference ID,Billable ID,Date,Amount,Description,Merchant Area,Category,Status,Reason\n";
  
  transactions.forEach(transaction => {
    csvContent += `"${transaction.referenceId}","${transaction.id}","${transaction.date}",${transaction.amount},"${transaction.description}","${transaction.area}","${transaction.category}","${transaction.status}","${transaction.reason}"\n`;
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', `careem_clawbacks_${new Date().toISOString().slice(0, 10)}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showNotification('Data exported to CSV successfully');
}

// Export invalid records to CSV
function exportInvalidRecords() {
  if (invalidRecords.length === 0) {
    showNotification('No invalid records to export', true);
    return;
  }
  
  // Create CSV content
  let csvContent = "Line #,Original Data,Error Reason,Details\n";
  
  invalidRecords.forEach(record => {
    csvContent += `${record.lineNumber},"${record.originalData}","${record.errorReason}","${record.details}"\n`;
  });
  
  // Create download link
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', `careem_invalid_records_${new Date().toISOString().slice(0, 10)}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showNotification('Invalid records exported to CSV successfully');
}

// Generate report
function generateReport() {
  if (transactions.length === 0) {
    showNotification('No data to generate report', true);
    return;
  }
  
  // Calculate statistics
  const stats = calculateStatistics();
  
  // Update report modal
  document.getElementById('reportDate').textContent = new Date().toLocaleString();
  document.getElementById('reportTotalClawbacks').textContent = formatCurrency(stats.totalClawbacks);
  document.getElementById('reportTotalPenalties').textContent = formatCurrency(stats.totalPenalties);
  document.getElementById('reportTotalCompensated').textContent = formatCurrency(stats.totalCompensated);
  document.getElementById('reportTotalDisputes').textContent = stats.mainDisputeCount;
  document.getElementById('reportNetAmount').textContent = formatCurrency(stats.netAmount);
  
  document.getElementById('reportTotalRecords').textContent = transactions.length;
  document.getElementById('reportTotalDeductions').textContent = formatCurrency(stats.totalDeductions);
  document.getElementById('reportAverageRecord').textContent = formatCurrency(stats.averageRecord);
  document.getElementById('reportRefundedAmount').textContent = formatCurrency(stats.refundedAmount);
  document.getElementById('reportCompensatedAmount').textContent = formatCurrency(stats.compensatedAmount);
  
  // Update main disputes table
  const mainDisputesTable = document.getElementById('mainDisputesTable');
  mainDisputesTable.innerHTML = '';
  
  const mainDisputeReasonsCount = {};
  transactions
    .filter(t => t.isMainDispute)
    .forEach(t => {
      mainDisputeReasonsCount[t.reason] = (mainDisputeReasonsCount[t.reason] || 0) + 1;
    });
  
  Object.entries(mainDisputeReasonsCount)
    .sort((a, b) => b[1] - a[1])
    .forEach(([reason, count]) => {
      const row = mainDisputesTable.insertRow();
      row.insertCell(0).textContent = reason;
      row.insertCell(1).textContent = count;
      row.insertCell(2).textContent = `${((count / transactions.length) * 100).toFixed(1)}%`;
    });
  
  document.getElementById('totalMainDisputesCount').textContent = stats.mainDisputeCount;
  document.getElementById('totalMainDisputesPercent').textContent = ((stats.mainDisputeCount / transactions.length) * 100).toFixed(1);
  
  // Update data quality section
  const reportDataQuality = document.getElementById('reportDataQuality');
  reportDataQuality.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Valid Records</div>
      <div class="stat-value">${transactions.length}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Invalid Records</div>
      <div class="stat-value">${invalidRecords.length}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Duplicate Records</div>
      <div class="stat-value">${duplicateRecords.length}</div>
    </div>
  `;
  
  // Update top reasons table
  const topReasonsTable = document.getElementById('topReasonsTable');
  topReasonsTable.innerHTML = '';
  
  const reasonsCount = {};
  transactions
    .filter(t => t.category === 'CLAWBACK')
    .forEach(t => {
      reasonsCount[t.reason] = (reasonsCount[t.reason] || 0) + 1;
    });
  
  Object.entries(reasonsCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10) // Top 10
    .forEach(([reason, count]) => {
      const row = topReasonsTable.insertRow();
      row.insertCell(0).textContent = reason;
      row.insertCell(1).textContent = count;
      row.insertCell(2).textContent = `${((count / transactions.length) * 100).toFixed(1)}%`;
    });
  
  // Update top branches table
  const topBranchesTable = document.getElementById('topBranchesTable');
  topBranchesTable.innerHTML = '';
  
  const branchesData = {};
  transactions.forEach(t => {
    if (!branchesData[t.area]) {
      branchesData[t.area] = {
        count: 0,
        totalDeductions: 0
      };
    }
    branchesData[t.area].count++;
    branchesData[t.area].totalDeductions += Math.abs(t.amount);
  });
  
  Object.entries(branchesData)
    .sort((a, b) => b[1].totalDeductions - a[1].totalDeductions)
    .slice(0, 10) // Top 10
    .forEach(([branch, data]) => {
      const row = topBranchesTable.insertRow();
      row.insertCell(0).textContent = branch;
      row.insertCell(1).textContent = formatCurrency(data.totalDeductions);
      row.insertCell(2).textContent = `${((data.totalDeductions / stats.totalDeductions) * 100).toFixed(1)}%`;
    });
  
  // Set footer date
  document.getElementById('reportFooterDate').textContent = new Date().toLocaleDateString();
  
  // Show modal
  document.getElementById('reportModal').style.display = 'block';
}

// Close report modal
function closeReport() {
  document.getElementById('reportModal').style.display = 'none';
}

// Print report
function printReport() {
  window.print();
}

// Export report to PDF
function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add title
  doc.setFontSize(20);
  doc.text('Careem Clawback Management Report', 105, 15, { align: 'center' });
  
  // Add date
  doc.setFontSize(12);
  doc.text(`Generated on: ${new Date().toLocaleString()}`, 105, 25, { align: 'center' });
  
  // Add summary
  doc.setFontSize(16);
  doc.text('Financial Summary', 20, 40);
  
  doc.setFontSize(12);
  const stats = calculateStatistics();
  doc.text(`Total Clawbacks: ${formatCurrency(stats.totalClawbacks)}`, 20, 50);
  doc.text(`Total Penalties: ${formatCurrency(stats.totalPenalties)}`, 20, 60);
  doc.text(`Total Compensated: ${formatCurrency(stats.totalCompensated)}`, 20, 70);
  doc.text(`Main Disputes: ${stats.mainDisputeCount}`, 20, 80);
  doc.text(`Net Amount: ${formatCurrency(stats.netAmount)}`, 20, 90);
  
  // Save the PDF
  doc.save(`careem_report_${new Date().toISOString().slice(0, 10)}.pdf`);
  
  showNotification('Report exported to PDF successfully');
}

// Toggle dark mode
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// Toggle reason consolidation
function toggleReasonConsolidation() {
  consolidateReasons = !consolidateReasons;
  updateReasonsList();
  applyFilters();
  showNotification(`Reason consolidation ${consolidateReasons ? 'enabled' : 'disabled'}`);
}

// Clear all filters
function clearFilters() {
  document.getElementById('filterRefId').value = '';
  document.getElementById('filterId').value = '';
  document.getElementById('filterArea').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterCategory').value = '';
  document.getElementById('filterReason').value = '';
  selectedReason = '';
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value = '';
  
  applyFilters();
  showNotification('Filters cleared successfully');
}

// Show notification
function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = 'notification show';
  if (isError) {
    notification.classList.add('error');
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Toggle reason dropdown
function toggleReasonDropdown() {
  const dropdown = document.getElementById('reasonDropdown');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// Select reason from dropdown
function selectReason(reason) {
  selectedReason = reason;
  document.getElementById('filterReason').value = reason;
  document.getElementById('reasonDropdown').style.display = 'none';
  applyFilters();
}

// Update reasons list for dropdown
function updateReasonsList() {
  const reasonsSet = new Set();
  
  transactions.forEach(transaction => {
    if (consolidateReasons) {
      reasonsSet.add(transaction.reason);
    } else {
      reasonsSet.add(transaction.description);
    }
  });
  
  reasonsList = Array.from(reasonsSet);
  
  // Update dropdown
  const dropdown = document.getElementById('reasonDropdown');
  dropdown.innerHTML = '';
  
  reasonsList.forEach(reason => {
    const option = document.createElement('div');
    option.className = 'reason-option';
    option.textContent = reason;
    option.onclick = () => selectReason(reason);
    dropdown.appendChild(option);
  });
  
  // Update reasons breakdown in dashboard
  updateReasonsBreakdown();
}

// Update reasons breakdown in dashboard
function updateReasonsBreakdown() {
  const reasonsCount = {};
  
  transactions.forEach(transaction => {
    const reason = consolidateReasons ? transaction.reason : transaction.description;
    reasonsCount[reason] = (reasonsCount[reason] || 0) + 1;
  });
  
  const reasonsListElement = document.getElementById('reasonsList');
  reasonsListElement.innerHTML = '';
  
  if (Object.keys(reasonsCount).length === 0) {
    reasonsListElement.innerHTML = '<li>No data available</li>';
    return;
  }
  
  Object.entries(reasonsCount)
    .sort((a, b) => b[1] - a[1])
    .forEach(([reason, count]) => {
      const li = document.createElement('li');
      
      // Check if it's a main dispute reason
      if (mainDisputeReasons.includes(reason)) {
        li.innerHTML = `
          <span class="reason main-dispute">${reason}</span>
          <span class="count">${count} (${((count / transactions.length) * 100).toFixed(1)}%)</span>
        `;
      } else {
        li.innerHTML = `
          <span class="reason">${reason}</span>
          <span class="count">${count} (${((count / transactions.length) * 100).toFixed(1)}%)</span>
        `;
      }
      
      reasonsListElement.appendChild(li);
    });
}

// Apply filters to transactions
function applyFilters() {
  const refIdFilter = document.getElementById('filterRefId').value.toLowerCase();
  const idFilter = document.getElementById('filterId').value.toLowerCase();
  const areaFilter = document.getElementById('filterArea').value.toLowerCase();
  const statusFilter = document.getElementById('filterStatus').value;
  const categoryFilter = document.getElementById('filterCategory').value;
  const reasonFilter = selectedReason;
  const dateFromFilter = document.getElementById('filterDateFrom').value;
  const dateToFilter = document.getElementById('filterDateTo').value;
  
  const filteredTransactions = transactions.filter(transaction => {
    // Reference ID filter
    if (refIdFilter && !transaction.referenceId.toLowerCase().includes(refIdFilter)) {
      return false;
    }
    
    // Billable ID filter
    if (idFilter && !transaction.id.toLowerCase().includes(idFilter)) {
      return false;
    }
    
    // Area filter
    if (areaFilter && !transaction.area.toLowerCase().includes(areaFilter)) {
      return false;
    }
    
    // Status filter
    if (statusFilter && transaction.status !== statusFilter) {
      return false;
    }
    
    // Category filter
    if (categoryFilter && transaction.category !== categoryFilter) {
      return false;
    }
    
    // Reason filter
    if (reasonFilter) {
      const reason = consolidateReasons ? transaction.reason : transaction.description;
      if (reason !== reasonFilter) {
        return false;
      }
    }
    
    // Date from filter
    if (dateFromFilter && transaction.date < dateFromFilter) {
      return false;
    }
    
    // Date to filter
    if (dateToFilter && transaction.date > dateToFilter) {
      return false;
    }
    
    return true;
  });
  
  // Update table
  updateTransactionTable(filteredTransactions);
  
  // Update dashboard with filtered data
  updateFilteredDashboard(filteredTransactions);
}

// Update transaction table
function updateTransactionTable(data) {
  const tableBody = document.querySelector('#dataTable tbody');
  tableBody.innerHTML = '';
  
  if (data.length === 0) {
    const row = tableBody.insertRow();
    const cell = row.insertCell();
    cell.colSpan = 9;
    cell.textContent = 'No transactions found';
    cell.style.textAlign = 'center';
    return;
  }
  
  data.forEach(transaction => {
    const row = tableBody.insertRow();
    
    // Reference ID
    row.insertCell(0).textContent = transaction.referenceId;
    
    // Billable ID
    row.insertCell(1).textContent = transaction.id;
    
    // Date
    row.insertCell(2).textContent = formatDate(parseDate(transaction.date));
    
    // Amount
    const amountCell = row.insertCell(3);
    amountCell.textContent = formatCurrency(transaction.amount);
    if (transaction.amount < 0) {
      amountCell.classList.add('negative');
    }
    
    // Description
    const descCell = row.insertCell(4);
    descCell.textContent = transaction.description;
    if (transaction.isMainDispute) {
      descCell.classList.add('dispute-highlight');
    }
    
    // Area
    row.insertCell(5).textContent = transaction.area;
    
    // Category
    const categoryCell = row.insertCell(6);
    const badge = document.createElement('span');
    badge.className = `category-badge ${transaction.category.toLowerCase()}`;
    badge.textContent = transaction.category;
    categoryCell.appendChild(badge);
    
    // Status
    const statusCell = row.insertCell(7);
    if (transaction.status) {
      const statusBadge = document.createElement('span');
      statusBadge.className = `category-badge ${transaction.status === 'Refunded' ? 'compensated' : 'dispute'}`;
      statusBadge.textContent = transaction.status;
      statusBadge.id = `status-${transaction.referenceId}-${transaction.id}`;
      statusCell.appendChild(statusBadge);
    }
    
    // Actions
    const actionCell = row.insertCell(8);
    
    // Only show toggle button for clawback transactions
    if (transaction.category === 'CLAWBACK' && transaction.isMainDispute) {
      const toggleButton = document.createElement('button');
      toggleButton.textContent = 'Toggle Status';
      toggleButton.className = 'toggle-status-btn';
      toggleButton.onclick = () => toggleTransactionStatus(transaction);
      actionCell.appendChild(toggleButton);
    }
    
    // Edit button
    const editButton = document.createElement('button');
    editButton.textContent = 'Edit';
    editButton.style.padding = '5px 10px';
    editButton.style.fontSize = '0.8em';
    editButton.onclick = () => editTransaction(transaction);
    actionCell.appendChild(editButton);
  });
}

// Toggle transaction status between Refunded and COMPENSATED
function toggleTransactionStatus(transaction) {
  // Find the transaction in the array
  const index = transactions.findIndex(t => 
    t.referenceId === transaction.referenceId && t.id === transaction.id
  );
  
  if (index === -1) return;
  
  // Toggle the status
  if (transactions[index].status === 'Refunded') {
    transactions[index].status = 'COMPENSATED';
  } else if (transactions[index].status === 'COMPENSATED') {
    transactions[index].status = 'Refunded';
  }
  
  // Update the status badge in the table
  const statusBadge = document.getElementById(`status-${transaction.referenceId}-${transaction.id}`);
  if (statusBadge) {
    statusBadge.textContent = transactions[index].status;
    statusBadge.className = `category-badge ${transactions[index].status === 'Refunded' ? 'compensated' : 'dispute'}`;
  }
  
  // Save to localStorage
  localStorage.setItem('careemTransactions', JSON.stringify(transactions));
  
  // Update dashboard and analysis
  updateDashboard();
  updateAnalysis();
  
  // Show notification
  showNotification(`Status changed to ${transactions[index].status} for ${transaction.referenceId}`);
}

// Edit transaction
function editTransaction(transaction) {
  // Create a simple modal for editing
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  `;
  
  content.innerHTML = `
    <h3 style="margin-top: 0; margin-bottom: 20px; color: var(--primary-dark);">Edit Transaction</h3>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">Reference ID:</label>
      <input type="text" id="editRefId" value="${transaction.referenceId}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly>
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">Billable ID:</label>
      <input type="text" id="editId" value="${transaction.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly>
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">Amount:</label>
      <input type="text" id="editAmount" value="${transaction.amount}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description:</label>
      <textarea id="editDescription" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;">${transaction.description}</textarea>
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">Merchant Area:</label>
      <input type="text" id="editArea" value="${transaction.area}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    ${transaction.category === 'CLAWBACK' && transaction.isMainDispute ? `
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600;">Status:</label>
      <select id="editStatus" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="Refunded" ${transaction.status === 'Refunded' ? 'selected' : ''}>Refunded</option>
        <option value="COMPENSATED" ${transaction.status === 'COMPENSATED' ? 'selected' : ''}>COMPENSATED</option>
      </select>
    </div>
    ` : ''}
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeEditModal()" style="padding: 8px 16px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button onclick="saveTransactionEdit('${transaction.referenceId}', '${transaction.id}')" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  // Store the modal reference globally for closing
  window.currentEditModal = modal;
}

// Close edit modal
function closeEditModal() {
  if (window.currentEditModal) {
    document.body.removeChild(window.currentEditModal);
    window.currentEditModal = null;
  }
}

// Save transaction edit
function saveTransactionEdit(referenceId, id) {
  // Find the transaction in the array
  const index = transactions.findIndex(t => t.referenceId === referenceId && t.id === id);
  
  if (index === -1) return;
  
  // Get the updated values
  const amount = parseFloat(document.getElementById('editAmount').value);
  const description = document.getElementById('editDescription').value.trim();
  const area = document.getElementById('editArea').value.trim();
  
  // Validate
  if (isNaN(amount)) {
    showNotification('Invalid amount format', true);
    return;
  }
  
  if (!description) {
    showNotification('Description cannot be empty', true);
    return;
  }
  
  // Update the transaction
  transactions[index].amount = amount;
  transactions[index].description = description;
  transactions[index].area = area;
  
  // Update status if applicable
  if (transactions[index].category === 'CLAWBACK' && transactions[index].isMainDispute) {
    transactions[index].status = document.getElementById('editStatus').value;
  }
  
  // Re-categorize if description changed
  const categoryInfo = categorizeTransaction(description);
  transactions[index].category = categoryInfo.category;
  transactions[index].isMainDispute = categoryInfo.isMainDispute;
  transactions[index].reason = categoryInfo.reason;
  
  // Save to localStorage
  localStorage.setItem('careemTransactions', JSON.stringify(transactions));
  
  // Close modal
  closeEditModal();
  
  // Update UI
  updateDashboard();
  updateBranchTable();
  updateAnalysis();
  applyFilters();
  
  showNotification('Transaction updated successfully');
}

// Sort table by column
function sortTable(column) {
  if (sortColumn === column) {
    sortAscending = !sortAscending;
  } else {
    sortColumn = column;
    sortAscending = true;
  }
  
  // Update sort indicators
  document.querySelectorAll('th').forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
  });
  
  const currentTh = Array.from(document.querySelectorAll('th')).find(th => 
    th.textContent.includes(column.replace(/([A-Z])/g, ' $1').trim())
  );
  
  if (currentTh) {
    currentTh.classList.add(sortAscending ? 'sorted-asc' : 'sorted-desc');
  }
  
  // Sort transactions
  transactions.sort((a, b) => {
    let valueA = a[column];
    let valueB = b[column];
    
    // Handle dates
    if (column === 'date') {
      valueA = new Date(valueA);
      valueB = new Date(valueB);
    }
    
    // Handle numbers
    if (column === 'amount') {
      valueA = parseFloat(valueA);
      valueB = parseFloat(valueB);
    }
    
    // Handle strings
    if (typeof valueA === 'string') {
      valueA = valueA.toLowerCase();
      valueB = valueB.toLowerCase();
    }
    
    if (valueA < valueB) {
      return sortAscending ? -1 : 1;
    }
    if (valueA > valueB) {
      return sortAscending ? 1 : -1;
    }
    return 0;
  });
  
  // Update table
  applyFilters();
}

// Update dashboard
function updateDashboard() {
  const stats = calculateStatistics();
  
  // Update summary cards
  document.getElementById('totalClawbacks').textContent = formatCurrency(stats.totalClawbacks);
  document.getElementById('totalPenalties').textContent = formatCurrency(stats.totalPenalties);
  document.getElementById('totalCompensated').textContent = formatCurrency(stats.totalCompensated);
  document.getElementById('totalDisputes').textContent = stats.mainDisputeCount;
  document.getElementById('netAmount').textContent = formatCurrency(stats.netAmount);
  
  // Update stat cards
  document.getElementById('totalRecords').textContent = transactions.length;
  document.getElementById('totalDeductions').textContent = formatCurrency(stats.totalDeductions);
  document.getElementById('averageRecord').textContent = formatCurrency(stats.averageRecord);
  document.getElementById('refundedAmount').textContent = formatCurrency(stats.refundedAmount);
  document.getElementById('compensatedAmount').textContent = formatCurrency(stats.compensatedAmount);
  
  // Update error stats
  const errorStats = document.getElementById('errorStats');
  if (invalidRecords.length > 0 || duplicateRecords.length > 0) {
    errorStats.style.display = 'flex';
    document.getElementById('invalidCount').textContent = invalidRecords.length;
    document.getElementById('duplicateCount').textContent = duplicateRecords.length;
    document.getElementById('validCount').textContent = transactions.length;
  } else {
    errorStats.style.display = 'none';
  }
  
  // Update invalid records table
  updateInvalidRecordsTable();
  
  // Update reasons breakdown
  updateReasonsBreakdown();
}

// Update dashboard with filtered data
function updateFilteredDashboard(filteredData) {
  const stats = calculateStatistics(filteredData);
  
  // Update stat cards with filtered data
  document.getElementById('totalRecords').textContent = filteredData.length;
  document.getElementById('totalDeductions').textContent = formatCurrency(stats.totalDeductions);
  document.getElementById('averageRecord').textContent = formatCurrency(stats.averageRecord);
  document.getElementById('refundedAmount').textContent = formatCurrency(stats.refundedAmount);
  document.getElementById('compensatedAmount').textContent = formatCurrency(stats.compensatedAmount);
}

// Update invalid records table
function updateInvalidRecordsTable() {
  const tableBody = document.getElementById('invalidRecordsTable');
  tableBody.innerHTML = '';
  
  if (invalidRecords.length === 0) {
    document.getElementById('invalidRecordsSection').style.display = 'none';
    return;
  }
  
  document.getElementById('invalidRecordsSection').style.display = 'block';
  
  invalidRecords.forEach(record => {
    const row = tableBody.insertRow();
    row.insertCell(0).textContent = record.lineNumber;
    row.insertCell(1).textContent = record.originalData;
    row.insertCell(2).textContent = record.errorReason;
    row.insertCell(3).textContent = record.details;
  });
}

// Update branch table
function updateBranchTable() {
  const tableBody = document.querySelector('#branchTable tbody');
  tableBody.innerHTML = '';
  
  if (transactions.length === 0) {
    const row = tableBody.insertRow();
    const cell = row.insertCell();
    cell.colSpan = 4;
    cell.textContent = 'No data available';
    cell.style.textAlign = 'center';
    return;
  }
  
  // Group by branch
  const branchesData = {};
  transactions.forEach(transaction => {
    if (!branchesData[transaction.area]) {
      branchesData[transaction.area] = {
        count: 0,
        totalDeductions: 0,
        reasons: {}
      };
    }
    
    branchesData[transaction.area].count++;
    branchesData[transaction.area].totalDeductions += Math.abs(transaction.amount);
    
    const reason = consolidateReasons ? transaction.reason : transaction.description;
    branchesData[transaction.area].reasons[reason] = (branchesData[transaction.area].reasons[reason] || 0) + 1;
  });
  
  // Sort by total deductions
  const sortedBranches = Object.entries(branchesData)
    .sort((a, b) => b[1].totalDeductions - a[1].totalDeductions);
  
  // Populate table
  sortedBranches.forEach(([branch, data]) => {
    const row = tableBody.insertRow();
    row.insertCell(0).textContent = branch;
    row.insertCell(1).textContent = data.count;
    row.insertCell(2).textContent = formatCurrency(data.totalDeductions);
    
    // Reasons
    const reasonsCell = row.insertCell(3);
    const topReasons = Object.entries(data.reasons)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([reason, count]) => `${reason} (${count})`)
      .join(', ');
    
    reasonsCell.textContent = topReasons;
  });
}

// Update analysis section
function updateAnalysis() {
  if (transactions.length === 0) {
    document.getElementById('executiveSummary').textContent = 'No data available. Please import data to generate analysis.';
    document.getElementById('disputeAnalysis').textContent = 'No data available. Please import data to generate analysis.';
    document.getElementById('financialAnalysis').textContent = 'No data available. Please import data to generate analysis.';
    document.getElementById('branchAnalysis').textContent = 'No data available. Please import data to generate analysis.';
    document.getElementById('recommendations').textContent = 'No data available. Please import data to generate analysis.';
    return;
  }
  
  const stats = calculateStatistics();
  
  // Executive Summary
  const executiveSummary = document.getElementById('executiveSummary');
  executiveSummary.innerHTML = `
    <p>This comprehensive analysis examines <span class="highlight">${transactions.length}</span> transactions with a total financial impact of <span class="negative-highlight">${formatCurrency(stats.netAmount)}</span>.</p>
    <p>Key findings show that <span class="highlight">${stats.mainDisputeCount}</span> (${((stats.mainDisputeCount / transactions.length) * 100).toFixed(1)}%) are main dispute reasons that Careem accepts for refunds.</p>
    <p>The average deduction per transaction is <span class="negative-highlight">${formatCurrency(stats.averageRecord)}</span>, indicating significant financial impact per incident.</p>
    <p>Data quality is maintained with ${invalidRecords.length} invalid records and ${duplicateRecords.length} duplicate records identified during processing.</p>
  `;
  
  // Main Dispute Reasons Analysis
  const disputeAnalysis = document.getElementById('disputeAnalysis');
  const mainDisputeReasonsCount = {};
  transactions
    .filter(t => t.isMainDispute)
    .forEach(t => {
      mainDisputeReasonsCount[t.reason] = (mainDisputeReasonsCount[t.reason] || 0) + 1;
    });
  
  const topDisputeReason = Object.entries(mainDisputeReasonsCount)
    .sort((a, b) => b[1] - a[1])[0];
  
  disputeAnalysis.innerHTML = `
    <p>The most prevalent main dispute reason is <span class="highlight">${topDisputeReason ? topDisputeReason[0] : 'N/A'}</span> with <span class="highlight">${topDisputeReason ? topDisputeReason[1] : 0}</span> occurrences.</p>
    <p>Main disputes constitute <span class="highlight">${((stats.mainDisputeCount / transactions.length) * 100).toFixed(1)}%</span> of all transactions but account for <span class="negative-highlight">${((stats.refundedAmount / stats.totalDeductions) * 100).toFixed(1)}%</span> of total deductions.</p>
    <p>This indicates that while main disputes are less frequent, they have a disproportionately high financial impact.</p>
    <p>Addressing these specific issues could yield significant improvements in overall financial performance.</p>
  `;
  
  // Financial Impact Analysis
  const financialAnalysis = document.getElementById('financialAnalysis');
  financialAnalysis.innerHTML = `
    <p>Total deductions amount to <span class="negative-highlight">${formatCurrency(stats.totalDeductions)}</span>, distributed as follows:</p>
    <ul>
      <li>Clawbacks: <span class="negative-highlight">${formatCurrency(stats.totalClawbacks)}</span> (${((stats.totalClawbacks / stats.totalDeductions) * 100).toFixed(1)}%)</li>
      <li>Penalties: <span class="negative-highlight">${formatCurrency(stats.totalPenalties)}</span> (${((stats.totalPenalties / stats.totalDeductions) * 100).toFixed(1)}%)</li>
    </ul>
    <p>Compensated amounts total <span class="highlight">${formatCurrency(stats.totalCompensated)}</span>, providing partial offset to the deductions.</p>
    <p>The net financial impact is <span class="negative-highlight">${formatCurrency(stats.netAmount)}</span>, representing the actual cost to the business.</p>
    <p>Refunded amounts total <span class="highlight">${formatCurrency(stats.refundedAmount)}</span>, while compensated amounts reach <span class="highlight">${formatCurrency(stats.compensatedAmount)}</span>.</p>
  `;
  
  // Branch Performance Analysis
  const branchAnalysis = document.getElementById('branchAnalysis');
  const branchesData = {};
  transactions.forEach(t => {
    if (!branchesData[t.area]) {
      branchesData[t.area] = {
        count: 0,
        totalDeductions: 0,
        mainDisputes: 0
      };
    }
    branchesData[t.area].count++;
    branchesData[t.area].totalDeductions += Math.abs(t.amount);
    if (t.isMainDispute) branchesData[t.area].mainDisputes++;
  });
  
  const sortedBranches = Object.entries(branchesData)
    .sort((a, b) => b[1].totalDeductions - a[1].totalDeductions);
  
  const worstBranch = sortedBranches[0];
  const bestBranch = sortedBranches[sortedBranches.length - 1];
  
  branchAnalysis.innerHTML = `
    <p>Branch performance varies significantly across the network:</p>
    <p>The highest-performing branch in terms of deductions is <span class="negative-highlight">${worstBranch ? worstBranch[0] : 'N/A'}</span> with <span class="negative-highlight">${worstBranch ? formatCurrency(worstBranch[1].totalDeductions) : '0'}</span> in total deductions.</p>
    <p>This branch accounts for <span class="negative-highlight">${worstBranch ? ((worstBranch[1].totalDeductions / stats.totalDeductions) * 100).toFixed(1) : 0}%</span> of all deductions.</p>
    <p>Conversely, the best-performing branch is <span class="highlight">${bestBranch ? bestBranch[0] : 'N/A'}</span> with minimal deductions.</p>
    <p>Branches with high main dispute rates should be prioritized for training and process improvement initiatives.</p>
  `;
  
  // Strategic Recommendations
  const recommendations = document.getElementById('recommendations');
  recommendations.innerHTML = `
    <h4>Strategic Action Plan</h4>
    <ol>
      <li><strong>Reduce Main Disputes:</strong> Focus on the top main dispute reasons, especially <span class="highlight">${topDisputeReason ? topDisputeReason[0] : 'N/A'}</span>. Implement targeted quality control measures and staff training programs.</li>
      <li><strong>Branch Performance Optimization:</strong> Provide additional training and support to underperforming branches, particularly <span class="negative-highlight">${worstBranch ? worstBranch[0] : 'N/A'}</span>. Consider implementing performance-based incentives.</li>
      <li><strong>Process Improvement:</strong> Review and enhance order preparation and packaging processes to reduce spills, damages, and incorrect items. Standardize procedures across all branches.</li>
      <li><strong>Customer Communication Enhancement:</strong> Improve communication protocols with customers regarding unavailable items to reduce "missing item" disputes. Implement real-time inventory updates.</li>
      <li><strong>Technology Integration:</strong> Leverage technology solutions for better order tracking, quality control, and customer feedback management.</li>
      <li><strong>Continuous Monitoring:</strong> Establish regular review cycles for clawback data to identify emerging issues and address them proactively.</li>
      <li><strong>Staff Training:</strong> Develop comprehensive training programs focused on reducing the most common dispute reasons and improving overall service quality.</li>
    </ol>
    <h4>Expected Outcomes</h4>
    <ul>
      <li>Reduction in main dispute rates by 30-50% within 6 months</li>
      <li>Decrease in overall deductions by 20-30% year-over-year</li>
      <li>Improved customer satisfaction scores</li>
      <li>Better consistency in service quality across all branches</li>
    </ul>
  `;
}

// Calculate statistics
function calculateStatistics(data = transactions) {
  const stats = {
    totalClawbacks: 0,
    totalPenalties: 0,
    totalCompensated: 0,
    mainDisputeCount: 0,
    refundedAmount: 0,
    compensatedAmount: 0,
    totalDeductions: 0,
    averageRecord: 0,
    netAmount: 0
  };
  
  data.forEach(transaction => {
    const absAmount = Math.abs(transaction.amount);
    
    if (transaction.category === 'CLAWBACK') {
      stats.totalClawbacks += absAmount;
    } else if (transaction.category === 'PENALTY') {
      stats.totalPenalties += absAmount;
    } else if (transaction.category === 'COMPENSATED') {
      stats.totalCompensated += absAmount;
    }
    
    if (transaction.isMainDispute) {
      stats.mainDisputeCount++;
    }
    
    if (transaction.status === 'Refunded') {
      stats.refundedAmount += absAmount;
    }
    
    if (transaction.status === 'COMPENSATED') {
      stats.compensatedAmount += absAmount;
    }
    
    if (transaction.amount < 0) {
      stats.totalDeductions += absAmount;
    }
  });
  
  stats.netAmount = stats.totalClawbacks + stats.totalPenalties - stats.totalCompensated;
  stats.averageRecord = data.length > 0 ? stats.totalDeductions / data.length : 0;
  
  return stats;
}

// Format currency
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'AED',
    minimumFractionDigits: 2
  }).format(amount);
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const reasonFilter = document.querySelector('.reason-filter');
  if (!reasonFilter.contains(event.target)) {
    document.getElementById('reasonDropdown').style.display = 'none';
  }
});
</script>
</body>
</html>
