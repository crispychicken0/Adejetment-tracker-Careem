<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Careem Clawback Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --primary: #4CAF50;
    --secondary: #2196F3;
    --clawback: #e74c3c;
    --penalty: #f39c12;
    --compensated: #27ae60;
    --dispute: #9b59b6;
    --bg-light: #f9f9f9;
    --bg-dark: #333;
    --text-light: #333;
    --text-dark: #fff;
    --card-bg: #fff;
    --border-color: #ddd;
    --hover-bg: #f0f0f0;
    --negative-color: #e74c3c;
    --shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  body.dark-mode {
    --bg-light: #333;
    --text-light: #fff;
    --card-bg: #444;
    --border-color: #555;
    --hover-bg: #555;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body { 
    font-family: 'Segoe UI', Arial, sans-serif; 
    margin: 20px; 
    background: var(--bg-light); 
    color: var(--text-light); 
    transition: background 0.3s, color 0.3s;
    line-height: 1.6;
  }

  .container { 
    max-width: 1200px; 
    margin: 0 auto; 
  }

  h2, h3 { 
    margin-bottom: 15px; 
    font-weight: 500;
    color: var(--primary);
  }

  .dashboard { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 15px; 
    margin-bottom: 20px; 
  }

  .dashboard-card { 
    background: var(--card-bg); 
    border-radius: 8px; 
    padding: 15px; 
    box-shadow: var(--shadow); 
    text-align: center; 
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .dashboard-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .dashboard-card h4 { 
    margin: 0 0 10px; 
    font-size: 1.1em; 
    color: var(--primary); 
  }

  .dashboard-card p { 
    margin: 0; 
    font-size: 1.5em; 
    font-weight: bold; 
  }

  .category-card {
    border-left: 4px solid;
  }

  .category-card.clawback {
    border-left-color: var(--clawback);
  }

  .category-card.penalty {
    border-left-color: var(--penalty);
  }

  .category-card.compensated {
    border-left-color: var(--compensated);
  }

  .category-card.dispute {
    border-left-color: var(--dispute);
  }

  .category-card h4 {
    color: var(--primary);
  }

  .category-card.clawback h4 {
    color: var(--clawback);
  }

  .category-card.penalty h4 {
    color: var(--penalty);
  }

  .category-card.compensated h4 {
    color: var(--compensated);
  }

  .category-card.dispute h4 {
    color: var(--dispute);
  }

  .reasons-card { 
    text-align: left; 
    max-height: 200px; 
    overflow-y: auto; 
  }

  .reasons-card ul { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
  }

  .reasons-card li { 
    padding: 5px 0; 
    border-bottom: 1px solid var(--border-color); 
    transition: background 0.2s;
  }

  .reasons-card li:hover {
    background: var(--hover-bg);
    padding-left: 5px;
  }

  .reasons-card li:last-child { 
    border-bottom: none; 
  }

  .reasons-card .reason { 
    font-weight: bold; 
  }

  .main-dispute {
    color: var(--dispute);
    font-weight: bold;
  }

  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 20px; 
    background: var(--card-bg); 
    border-radius: 8px; 
    overflow: hidden; 
    box-shadow: var(--shadow); 
  }

  th, td { 
    border: 1px solid var(--border-color); 
    padding: 12px; 
    text-align: center; 
  }

  th { 
    background: var(--hover-bg); 
    cursor: pointer; 
    font-weight: bold;
    position: relative;
    user-select: none;
  }

  th:hover { 
    background: var(--hover-bg); 
  }

  th::after {
    content: '⇅';
    position: absolute;
    right: 8px;
    opacity: 0.5;
  }

  th.sorted-asc::after {
    content: '↑';
    opacity: 1;
  }

  th.sorted-desc::after {
    content: '↓';
    opacity: 1;
  }

  .negative { 
    color: var(--negative-color); 
    font-weight: bold; 
  }

  .category-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
  }

  .category-badge.clawback {
    background-color: var(--clawback);
  }

  .category-badge.penalty {
    background-color: var(--penalty);
  }

  .category-badge.compensated {
    background-color: var(--compensated);
  }

  .category-badge.dispute {
    background-color: var(--dispute);
  }

  .dispute-reason {
    color: var(--dispute);
    font-weight: bold;
  }

  .controls { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    margin-bottom: 15px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .control-group label {
    font-weight: 500;
    font-size: 0.9em;
  }

  input, textarea, select { 
    padding: 10px; 
    border: 1px solid var(--border-color); 
    border-radius: 4px; 
    width: 100%; 
    box-sizing: border-box;
    transition: border-color 0.2s;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
  }

  textarea { 
    resize: vertical; 
    min-height: 100px;
  }

  button { 
    background: var(--primary); 
    color: white; 
    border: none; 
    padding: 10px 16px; 
    cursor: pointer; 
    border-radius: 4px; 
    transition: background 0.2s, transform 0.1s;
    font-weight: 500;
  }

  button:active {
    transform: scale(0.98);
  }

  button:disabled { 
    background: #ccc; 
    cursor: not-allowed; 
    opacity: 0.7;
  }

  button:hover:not(:disabled) { 
    background: #45a049; 
  }

  button.danger {
    background: var(--negative-color);
  }

  button.danger:hover:not(:disabled) {
    background: #c0392b;
  }

  .section { 
    margin-top: 40px; 
    padding-top: 20px; 
    border-top: 2px solid var(--border-color); 
  }

  .notification { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    padding: 15px 20px; 
    background: var(--primary); 
    color: white; 
    border-radius: 4px; 
    display: none; 
    z-index: 1000; 
    opacity: 0; 
    transition: opacity 0.5s;
    box-shadow: var(--shadow);
    max-width: 300px;
  }

  .notification.show { 
    opacity: 1; 
    display: block; 
  }

  .notification.error { 
    background: var(--negative-color); 
  }

  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--hover-bg);
    border-radius: 4px;
    padding: 15px;
    flex: 1;
    min-width: 150px;
    transition: transform 0.2s;
  }

  .stat-card:hover {
    transform: translateY(-3px);
  }

  .stat-label {
    font-size: 0.9em;
    color: #666;
  }

  body.dark-mode .stat-label {
    color: #ccc;
  }

  .stat-value {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--primary);
  }

  .report-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow-y: auto;
  }

  .report-content {
    background-color: var(--card-bg);
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: var(--shadow);
  }

  .close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
  }

  .close:hover {
    color: var(--negative-color);
  }

  .report-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
  }

  .report-section {
    margin-bottom: 25px;
  }

  .report-section h3 {
    margin-bottom: 15px;
    color: var(--primary);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
  }

  .report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  .report-table th, .report-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .report-table th {
    background-color: var(--hover-bg);
    font-weight: bold;
  }

  .report-footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 15px;
    border-top: 2px solid var(--border-color);
    font-size: 0.9em;
    color: #666;
  }

  body.dark-mode .report-footer {
    color: #ccc;
  }

  .error-table {
    margin-top: 20px;
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .error-table th, .error-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .error-table th {
    background-color: var(--hover-bg);
    font-weight: bold;
  }

  .error-reason {
    color: var(--negative-color);
    font-weight: bold;
  }

  .error-details {
    font-size: 0.9em;
    color: #666;
  }

  body.dark-mode .error-details {
    color: #ccc;
  }

  .error-stats {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  .error-stat {
    background: #ffebee;
    border-radius: 4px;
    padding: 10px;
    flex: 1;
    text-align: center;
  }

  body.dark-mode .error-stat {
    background: #555;
  }

  .error-stat-label {
    font-size: 0.9em;
    color: #666;
  }

  body.dark-mode .error-stat-label {
    color: #ccc;
  }

  .error-stat-value {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--negative-color);
  }

  .reason-filter {
    position: relative;
  }

  .reason-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: var(--shadow);
  }

  .reason-option {
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .reason-option:hover {
    background: var(--hover-bg);
  }

  .reason-option.selected {
    background: var(--primary);
    color: white;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .file-upload {
    position: relative;
    display: inline-block;
    cursor: pointer;
    overflow: hidden;
  }

  .file-upload input[type=file] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .file-upload-label {
    display: block;
    padding: 10px 16px;
    background: var(--secondary);
    color: white;
    border-radius: 4px;
    font-weight: 500;
    transition: background 0.2s;
  }

  .file-upload:hover .file-upload-label {
    background: #0d8bf2;
  }

  .summary-section {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }

  .summary-title {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--primary);
    text-align: center;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
  }

  .summary-item {
    text-align: center;
    padding: 10px;
    border-radius: 4px;
    background: var(--hover-bg);
  }

  .summary-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
  }

  .summary-value {
    font-size: 1.3em;
    font-weight: bold;
  }

  .summary-item.clawback .summary-value {
    color: var(--clawback);
  }

  .summary-item.penalty .summary-value {
    color: var(--penalty);
  }

  .summary-item.compensated .summary-value {
    color: var(--compensated);
  }

  .summary-item.dispute .summary-value {
    color: var(--dispute);
  }

  .dispute-highlight {
    background-color: rgba(155, 89, 182, 0.1);
    border-left: 4px solid var(--dispute);
    padding-left: 10px;
  }

  .analysis-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }

  .analysis-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--primary);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
  }

  .analysis-content {
    font-size: 0.95em;
    line-height: 1.6;
  }

  .highlight {
    background-color: rgba(76, 175, 80, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
  }

  .negative-highlight {
    background-color: rgba(231, 76, 60, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
    color: var(--negative-color);
  }

  .import-options {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: var(--shadow);
  }

  .import-options h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--primary);
  }

  .date-range {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
  }

  .date-range input {
    flex: 1;
  }

  .action-select {
    padding: 5px;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-light);
    cursor: pointer;
  }

  .action-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
  }

  .confirm-dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }

  .confirm-content {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    text-align: center;
    box-shadow: var(--shadow);
  }

  .confirm-content h3 {
    margin-bottom: 15px;
    color: var(--primary);
  }

  .confirm-content p {
    margin-bottom: 20px;
  }

  .confirm-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  @media (max-width: 600px) {
    body { 
      margin: 10px; 
    }
    
    table { 
      display: block; 
      overflow-x: auto; 
    }
    
    .controls { 
      flex-direction: column; 
    }
    
    .dashboard { 
      grid-template-columns: 1fr; 
    }
    
    .stats-container {
      flex-direction: column;
    }
    
    .report-content {
      width: 95%;
      margin: 10% auto;
    }
    
    .stat-card {
      min-width: 100%;
    }
    
    .summary-grid {
      grid-template-columns: 1fr;
    }
    
    .date-range {
      flex-direction: column;
      gap: 5px;
    }
    
    .confirm-content {
      width: 90%;
    }
  }
</style>
</head>

<body>

<div class="container">
  <h2>Careem Clawback Tracker</h2>

  <div class="section">
    <h3>Import Data</h3>
    
    <div class="import-options">
      <h4>Date Range Filter (Optional)</h4>
      <div class="date-range">
        <label for="dateFrom">From Date:</label>
        <input type="date" id="importDateFrom">
        <label for="dateTo">To Date:</label>
        <input type="date" id="importDateTo">
      </div>
    </div>
    
    <div class="control-group">
      <label for="rawData">Paste clawback data (tab or comma separated):</label>
      <textarea id="rawData" placeholder="REF123&#9;BILL456&#9;9/16/2025&#9;-50.00&#9;Food__Customer__Quality Issues__Food is overcooked/burnt&#9;Downtown Dubai"></textarea>
    </div>
    
    <div class="controls">
      <button onclick="importData()">Import Data</button>
      
      <div class="file-upload">
        <input type="file" id="csvFile" accept=".csv" onchange="importFromCSV()">
        <label for="csvFile" class="file-upload-label">Import from CSV</label>
      </div>
      
      <button onclick="exportToCSV()">Export to CSV</button>
      <button onclick="exportInvalidRecords()">Export Invalid Records</button>
      <button onclick="generateReport()">Generate Report</button>
      <button onclick="clearAllData()" class="danger">Clear All Data</button>
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    </div>
  </div>

  <div class="section">
    <h3>Overall Summary</h3>
    <div class="summary-section">
      <div class="summary-title">Financial Overview</div>
      <div class="summary-grid">
        <div class="summary-item clawback">
          <div class="summary-label">Total Clawbacks</div>
          <div class="summary-value" id="totalClawbacks">0</div>
        </div>
        <div class="summary-item penalty">
          <div class="summary-label">Total Penalties</div>
          <div class="summary-value" id="totalPenalties">0</div>
        </div>
        <div class="summary-item compensated">
          <div class="summary-label">Total Compensated</div>
          <div class="summary-value" id="totalCompensated">0</div>
        </div>
        <div class="summary-item dispute">
          <div class="summary-label">Main Disputes</div>
          <div class="summary-value" id="totalDisputes">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Net Amount</div>
          <div class="summary-value" id="netAmount">0</div>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Dashboard</h3>
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">Total Records</div>
        <div class="stat-value" id="totalRecords">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Deductions</div>
        <div class="stat-value" id="totalDeductions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average per Record</div>
        <div class="stat-value" id="averageRecord">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Refunded Amount</div>
        <div class="stat-value" id="refundedAmount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Compensated Amount</div>
        <div class="stat-value" id="compensatedAmount">0</div>
      </div>
    </div>
    
    <div id="errorStats" class="error-stats" style="display: none;">
      <div class="error-stat">
        <div class="error-stat-label">Invalid Records</div>
        <div class="error-stat-value" id="invalidCount">0</div>
      </div>
      <div class="error-stat">
        <div class="error-stat-label">Duplicate Records</div>
        <div class="error-stat-value" id="duplicateCount">0</div>
      </div>
      <div class="error-stat">
        <div class="error-stat-label">Valid Records</div>
        <div class="error-stat-value" id="validCount">0</div>
      </div>
    </div>
    
    <div class="dashboard" id="reasonsBreakdown">
      <div class="dashboard-card reasons-card">
        <h4>Reasons Breakdown</h4>
        <ul id="reasonsList">
          <li>No data available</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="section" id="invalidRecordsSection" style="display: none;">
    <h3>Data Quality Issues</h3>
    <table class="error-table">
      <thead>
        <tr>
          <th>Line #</th>
          <th>Original Data</th>
          <th>Error Reason</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="invalidRecordsTable"></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Filters</h3>
    <div class="controls">
      <div class="control-group">
        <label for="filterRefId">Reference ID:</label>
        <input type="text" id="filterRefId" onkeyup="applyFilters()" placeholder="Filter by Reference ID">
      </div>
      
      <div class="control-group">
        <label for="filterId">Billable ID:</label>
        <input type="text" id="filterId" onkeyup="applyFilters()" placeholder="Filter by Billable ID">
      </div>
      
      <div class="control-group">
        <label for="filterArea">Merchant Area:</label>
        <input type="text" id="filterArea" onkeyup="applyFilters()" placeholder="Filter by Area">
      </div>
      
      <div class="control-group">
        <label for="filterStatus">Status:</label>
        <select id="filterStatus" onchange="applyFilters()">
          <option value="">All</option>
          <option value="Refunded">Refunded</option>
          <option value="Compensated">Compensated</option>
          <option value="Charged">Charged</option>
          <option value="Pending">Pending</option>
          <option value="Resolved">Resolved</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="filterCategory">Category:</label>
        <select id="filterCategory" onchange="applyFilters()">
          <option value="">All</option>
          <option value="CLAWBACK">Clawback</option>
          <option value="PENALTY">Penalty</option>
          <option value="COMPENSATED">Compensated</option>
        </select>
      </div>
      
      <div class="control-group">
        <label for="filterReason">Reason:</label>
        <div class="reason-filter">
          <input type="text" id="filterReason" placeholder="Select or type reason" readonly onclick="toggleReasonDropdown()">
          <div class="reason-dropdown" id="reasonDropdown"></div>
        </div>
      </div>
      
      <div class="control-group">
        <label for="filterDateFrom">From Date:</label>
        <input type="date" id="filterDateFrom" onchange="applyFilters()">
      </div>
      
      <div class="control-group">
        <label for="filterDateTo">To Date:</label>
        <input type="date" id="filterDateTo" onchange="applyFilters()">
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Transactions</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th onclick="sortTable('referenceId')">Reference ID</th>
          <th onclick="sortTable('id')">Billable ID</th>
          <th onclick="sortTable('date')">Date</th>
          <th onclick="sortTable('amount')">Amount</th>
          <th onclick="sortTable('description')">Description</th>
          <th onclick="sortTable('area')">Merchant Area</th>
          <th onclick="sortTable('category')">Category</th>
          <th onclick="sortTable('status')">Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Branch Summary (Orders and Reasons per Branch)</h3>
    <table id="branchTable">
      <thead>
        <tr>
          <th>Branch</th>
          <th>Order Count</th>
          <th>Total Deductions</th>
          <th>Reasons</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Analysis Report</h3>
    <div class="analysis-card">
      <div class="analysis-title">Executive Summary</div>
      <div class="analysis-content" id="executiveSummary">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Main Dispute Reasons Analysis</div>
      <div class="analysis-content" id="disputeAnalysis">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Financial Impact Analysis</div>
      <div class="analysis-content" id="financialAnalysis">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Branch Performance Analysis</div>
      <div class="analysis-content" id="branchAnalysis">
        No data available. Please import data to generate analysis.
      </div>
    </div>
    
    <div class="analysis-card">
      <div class="analysis-title">Recommendations</div>
      <div class="analysis-content" id="recommendations">
        No data available. Please import data to generate analysis.
      </div>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<!-- Report Modal -->
<div id="reportModal" class="report-modal">
  <div class="report-content" id="reportContent">
    <span class="close" onclick="closeReport()">&times;</span>
    <div class="report-header">
      <h2>Careem Clawback Management Report</h2>
      <p id="reportDate"></p>
    </div>
    <div class="report-section">
      <h3>Overall Financial Summary</h3>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">Total Clawbacks</div>
          <div class="stat-value" id="reportTotalClawbacks">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Penalties</div>
          <div class="stat-value" id="reportTotalPenalties">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Compensated</div>
          <div class="stat-value" id="reportTotalCompensated">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Main Disputes</div>
          <div class="stat-value" id="reportTotalDisputes">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Net Amount</div>
          <div class="stat-value" id="reportNetAmount">0</div>
        </div>
      </div>
    </div>
    <div class="report-section">
      <h3>Executive Summary</h3>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">Total Transactions</div>
          <div class="stat-value" id="reportTotalRecords">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Deductions</div>
          <div class="stat-value" id="reportTotalDeductions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average per Transaction</div>
          <div class="stat-value" id="reportAverageRecord">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Refunded Amount</div>
          <div class="stat-value" id="reportRefundedAmount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Compensated Amount</div>
          <div class="stat-value" id="reportCompensatedAmount">0</div>
        </div>
      </div>
    </div>
    <div class="report-section">
      <h3>Main Dispute Reasons (Careem Accepted Refunds)</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Reason</th>
            <th>Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="mainDisputesTable"></tbody>
      </table>
      <p style="margin-top: 10px; font-style: italic;">
        Total main disputes: <span id="totalMainDisputesCount">0</span> (<span id="totalMainDisputesPercent">0</span>% of all transactions)
      </p>
    </div>
    <div class="report-section">
      <h3>Data Quality Summary</h3>
      <div id="reportDataQuality" class="stats-container"></div>
    </div>
    <div class="report-section">
      <h3>Top Reasons for Clawbacks</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Reason</th>
            <th>Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="topReasonsTable"></tbody>
      </table>
    </div>
    <div class="report-section">
      <h3>Top Branches by Deduction Amount</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Branch</th>
            <th>Total Deductions</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="topBranchesTable"></tbody>
      </table>
    </div>
    <div class="report-footer">
      <p>Generated by Careem Clawback Tracker on <span id="reportFooterDate"></span></p>
    </div>
    <div class="controls">
      <button onclick="printReport()">Print Report</button>
      <button onclick="exportToPDF()">Export as PDF</button>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<div id="confirmDialog" class="confirm-dialog" style="display: none;">
  <div class="confirm-content">
    <h3>Confirm Action</h3>
    <p id="confirmMessage">Are you sure you want to proceed?</p>
    <div class="confirm-buttons">
      <button id="confirmYes" class="danger">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
</div>

<script>
// Global variables
let transactions = [];
let invalidRecords = [];
let duplicateRecords = [];
let sortColumn = null;
let sortAscending = true;
let reasonsList = [];
let selectedReason = "";
let isProcessing = false;

// Main dispute reasons that Careem accepts for refunds
const mainDisputeReasons = [
  "Spilled / damaged",
  "Missing or unavailable items",
  "Wrong item sent",
  "Partner Did not Prepare"
];

// Predefined reasons mapping in order
const predefinedReasons = [
  "Spilled / damaged",           // Main dispute reason
  "Missing or unavailable items", // Main dispute reason
  "Wrong item sent",             // Main dispute reason
  "Partner Did not Prepare",      // Main dispute reason
  "Food is overcooked/burnt",
  "Food is undercooked",
  "Hair in the food",
  "Foul Smell",
  "My Food is not edible (SelfServe)",
  "Instructions not followed",
  "Penalty for clawback complaint reason",
  "Penalties for Order",
  "Clawback Reversals",
  "Additional Penalty"
];

// Keywords for each predefined reason
const reasonKeywords = {
  "Spilled / damaged": ["spilled", "damaged", "spill", "damage", "broken", "leak", "mess", "ruined"],
  "Missing or unavailable items": ["missing", "unavailable", "not available", "out of stock", "no", "didn't get"],
  "Wrong item sent": ["wrong", "incorrect", "mistake", "different", "not what I ordered", "substituted"],
  "Partner Did not Prepare": ["not prepared", "didn't prepare", "not ready", "not made", "not cooked"],
  "Food is overcooked/burnt": ["overcooked", "burnt", "burned", "too done", "charred"],
  "Food is undercooked": ["undercooked", "raw", "not cooked", "uncooked", "pink", "bloody"],
  "Hair in the food": ["hair", "hair in food", "hair in my food"],
  "Foul Smell": ["smell", "smells", "stinks", "bad smell", "weird smell"],
  "My Food is not edible (SelfServe)": ["not edible", "inedible", "couldn't eat", "can't eat", "uneatable"],
  "Instructions not followed": ["instructions", "notes", "request", "special instructions", "not followed"],
  "Penalty for clawback complaint reason": ["penalty", "fine", "charge", "fee", "deduction"],
  "Penalties for Order": ["penalties", "order penalty", "order fine"],
  "Clawback Reversals": ["reversal", "reversed", "refund", "credited back"],
  "Additional Penalty": ["additional", "extra", "more penalty"]
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Load data from localStorage if available
  const savedData = localStorage.getItem('careemClawbackData');
  if (savedData) {
    try {
      const parsedData = JSON.parse(savedData);
      transactions = parsedData.transactions || [];
      invalidRecords = parsedData.invalidRecords || [];
      duplicateRecords = parsedData.duplicateRecords || [];
      updateUI();
      console.log('Loaded data from localStorage:', transactions.length, 'transactions');
    } catch (e) {
      console.error('Error loading saved data:', e);
      showNotification('Error loading saved data', 'error');
    }
  }
  
  // Initialize date inputs with current month
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  
  document.getElementById('importDateFrom').valueAsDate = firstDay;
  document.getElementById('importDateTo').valueAsDate = lastDay;
  document.getElementById('filterDateFrom').valueAsDate = firstDay;
  document.getElementById('filterDateTo').valueAsDate = lastDay;
  
  // Initialize reasons dropdown
  updateReasonsDropdown();
});

// Import data from textarea
function importData() {
  const rawData = document.getElementById('rawData').value.trim();
  if (!rawData) {
    showNotification('Please enter data to import', 'error');
    return;
  }
  
  const dateFrom = document.getElementById('importDateFrom').value;
  const dateTo = document.getElementById('importDateTo').value;
  
  // Process the data
  processData(rawData, dateFrom, dateTo);
}

// Process data from textarea or CSV
function processData(data, dateFrom, dateTo) {
  isProcessing = true;
  showNotification('Processing data...', 'info');
  
  // Split data into lines
  const lines = data.split('\n');
  const newTransactions = [];
  const newInvalidRecords = [];
  const seenIds = new Set();
  
  // Add existing IDs to the set to check for duplicates
  transactions.forEach(t => seenIds.add(t.referenceId));
  
  // Process each line
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Split by tab or comma
    const parts = line.split(/\t|,/);
    if (parts.length < 6) {
      newInvalidRecords.push({
        line: i + 1,
        originalData: line,
        error: 'Invalid format',
        details: 'Expected at least 6 columns (Reference ID, Billable ID, Date, Amount, Description, Area)'
      });
      continue;
    }
    
    const referenceId = parts[0].trim();
    const id = parts[1].trim();
    const dateStr = parts[2].trim();
    const amountStr = parts[3].trim();
    const description = parts[4].trim();
    const area = parts[5].trim();
    
    // Check for duplicate reference ID
    if (seenIds.has(referenceId)) {
      newInvalidRecords.push({
        line: i + 1,
        originalData: line,
        error: 'Duplicate Reference ID',
        details: `Reference ID "${referenceId}" already exists`
      });
      continue;
    }
    
    // Parse date
    const date = parseDate(dateStr);
    if (!date) {
      newInvalidRecords.push({
        line: i + 1,
        originalData: line,
        error: 'Invalid date',
        details: `Could not parse date: "${dateStr}"`
      });
      continue;
    }
    
    // Check if date is within range
    if (dateFrom && date < new Date(dateFrom)) {
      newInvalidRecords.push({
        line: i + 1,
        originalData: line,
        error: 'Date out of range',
        details: `Date is before the specified "From Date"`
      });
      continue;
    }
    
    if (dateTo && date > new Date(dateTo)) {
      newInvalidRecords.push({
        line: i + 1,
        originalData: line,
        error: 'Date out of range',
        details: `Date is after the specified "To Date"`
      });
      continue;
    }
    
    // Parse amount
    const amount = parseFloat(amountStr);
    if (isNaN(amount)) {
      newInvalidRecords.push({
        line: i + 1,
        originalData: line,
        error: 'Invalid amount',
        details: `Could not parse amount: "${amountStr}"`
      });
      continue;
    }
    
    // Determine category and status
    const { category, status, reason } = categorizeTransaction(description, amount);
    
    // Add to transactions
    const transaction = {
      referenceId,
      id,
      date,
      amount,
      description,
      area,
      category,
      status,
      reason
    };
    
    newTransactions.push(transaction);
    seenIds.add(referenceId);
  }
  
  // Add new transactions to the list (append instead of replace)
  transactions.push(...newTransactions);
  invalidRecords.push(...newInvalidRecords);
  
  // Update UI
  updateUI();
  
  // Save to localStorage
  saveToLocalStorage();
  
  // Show notification
  const validCount = newTransactions.length;
  const invalidCount = newInvalidRecords.length;
  
  if (validCount > 0) {
    showNotification(`Successfully imported ${validCount} records`, 'success');
    console.log(`Imported ${validCount} valid records`);
  }
  
  if (invalidCount > 0) {
    showNotification(`Found ${invalidCount} invalid records`, 'warning');
    console.log(`Found ${invalidCount} invalid records`);
  }
  
  isProcessing = false;
}

// Parse date in various formats
function parseDate(dateStr) {
  // Try MM/DD/YYYY format
  const parts1 = dateStr.split('/');
  if (parts1.length === 3) {
    const month = parseInt(parts1[0]);
    const day = parseInt(parts1[1]);
    const year = parseInt(parts1[2]);
    
    if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 2000) {
      return new Date(year, month - 1, day);
    }
  }
  
  // Try YYYY-MM-DD format
  const parts2 = dateStr.split('-');
  if (parts2.length === 3) {
    const year = parseInt(parts2[0]);
    const month = parseInt(parts2[1]);
    const day = parseInt(parts2[2]);
    
    if (year >= 2000 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
      return new Date(year, month - 1, day);
    }
  }
  
  // Try DD-MM-YYYY format
  if (parts2.length === 3) {
    const day = parseInt(parts2[0]);
    const month = parseInt(parts2[1]);
    const year = parseInt(parts2[2]);
    
    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2000) {
      return new Date(year, month - 1, day);
    }
  }
  
  // Try parsing as Date object
  const date = new Date(dateStr);
  if (!isNaN(date.getTime())) {
    return date;
  }
  
  return null;
}

// Categorize transaction based on description and amount
function categorizeTransaction(description, amount) {
  let category = 'CLAWBACK';
  let status = 'Refunded';
  let reason = description;
  
  // Check if it's a penalty
  if (description.toLowerCase().includes('penalty') || 
      description.toLowerCase().includes('fine') ||
      description.toLowerCase().includes('charge')) {
    category = 'PENALTY';
    status = 'Charged';
  }
  
  // Check if it's compensated
  if (description.toLowerCase().includes('compensat') || 
      description.toLowerCase().includes('reversal') ||
      description.toLowerCase().includes('credit')) {
    category = 'COMPENSATED';
    status = 'Compensated';
  }
  
  // Try to match with predefined reasons
  const matchedReason = matchReason(description);
  if (matchedReason) {
    reason = matchedReason;
  }
  
  return { category, status, reason };
}

// Match description to a predefined reason
function matchReason(description) {
  const descLower = description.toLowerCase();
  
  // Check for main dispute reasons first
  for (const reason of mainDisputeReasons) {
    if (reasonKeywords[reason]) {
      for (const keyword of reasonKeywords[reason]) {
        if (descLower.includes(keyword)) {
          return reason;
        }
      }
    }
  }
  
  // Check for other reasons
  for (const reason of predefinedReasons) {
    if (reasonKeywords[reason]) {
      for (const keyword of reasonKeywords[reason]) {
        if (descLower.includes(keyword)) {
          return reason;
        }
      }
    }
  }
  
  return null;
}

// Import data from CSV file
function importFromCSV() {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  
  if (!file) {
    showNotification('Please select a CSV file', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    document.getElementById('rawData').value = content;
    importData();
  };
  
  reader.readAsText(file);
}

// Export data to CSV
function exportToCSV() {
  if (transactions.length === 0) {
    showNotification('No data to export', 'error');
    return;
  }
  
  let csv = 'Reference ID,Billable ID,Date,Amount,Description,Area,Category,Status,Reason\n';
  
  transactions.forEach(t => {
    const dateStr = t.date.toLocaleDateString();
    csv += `${t.referenceId},${t.id},${dateStr},${t.amount},"${t.description}","${t.area}",${t.category},${t.status},"${t.reason}"\n`;
  });
  
  downloadCSV(csv, 'careem_clawback_data.csv');
}

// Export invalid records to CSV
function exportInvalidRecords() {
  if (invalidRecords.length === 0) {
    showNotification('No invalid records to export', 'error');
    return;
  }
  
  let csv = 'Line #,Original Data,Error Reason,Details\n';
  
  invalidRecords.forEach(r => {
    csv += `${r.line},"${r.originalData}","${r.error}","${r.details}"\n`;
  });
  
  downloadCSV(csv, 'careem_invalid_records.csv');
}

// Download CSV file
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.setAttribute('hidden', '');
  a.setAttribute('href', url);
  a.setAttribute('download', filename);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  showNotification(`Exported to ${filename}`, 'success');
}

// Generate and display report
function generateReport() {
  if (transactions.length === 0) {
    showNotification('No data available for report', 'error');
    return;
  }
  
  // Update report date
  const now = new Date();
  const dateStr = now.toLocaleDateString();
  document.getElementById('reportDate').textContent = dateStr;
  document.getElementById('reportFooterDate').textContent = dateStr;
  
  // Calculate summary statistics
  const stats = calculateStats();
  
  // Update financial summary
  document.getElementById('reportTotalClawbacks').textContent = formatCurrency(stats.totalClawbacks);
  document.getElementById('reportTotalPenalties').textContent = formatCurrency(stats.totalPenalties);
  document.getElementById('reportTotalCompensated').textContent = formatCurrency(stats.totalCompensated);
  document.getElementById('reportTotalDisputes').textContent = stats.totalDisputes;
  document.getElementById('reportNetAmount').textContent = formatCurrency(stats.netAmount);
  
  // Update executive summary
  document.getElementById('reportTotalRecords').textContent = stats.totalRecords;
  document.getElementById('reportTotalDeductions').textContent = formatCurrency(stats.totalDeductions);
  document.getElementById('reportAverageRecord').textContent = formatCurrency(stats.averageRecord);
  document.getElementById('reportRefundedAmount').textContent = formatCurrency(stats.refundedAmount);
  document.getElementById('reportCompensatedAmount').textContent = formatCurrency(stats.compensatedAmount);
  
  // Update main disputes table
  const mainDisputesTable = document.getElementById('mainDisputesTable');
  mainDisputesTable.innerHTML = '';
  
  let totalMainDisputes = 0;
  
  mainDisputeReasons.forEach(reason => {
    const count = transactions.filter(t => t.reason === reason).length;
    if (count > 0) {
      totalMainDisputes += count;
      const percent = ((count / stats.totalRecords) * 100).toFixed(1);
      
      const row = mainDisputesTable.insertRow();
      row.insertCell(0).textContent = reason;
      row.insertCell(1).textContent = count;
      row.insertCell(2).textContent = `${percent}%`;
    }
  });
  
  document.getElementById('totalMainDisputesCount').textContent = totalMainDisputes;
  document.getElementById('totalMainDisputesPercent').textContent = ((totalMainDisputes / stats.totalRecords) * 100).toFixed(1);
  
  // Update data quality summary
  const reportDataQuality = document.getElementById('reportDataQuality');
  reportDataQuality.innerHTML = '';
  
  const invalidStat = document.createElement('div');
  invalidStat.className = 'stat-card';
  invalidStat.innerHTML = `
    <div class="stat-label">Invalid Records</div>
    <div class="stat-value">${invalidRecords.length}</div>
  `;
  reportDataQuality.appendChild(invalidStat);
  
  const duplicateStat = document.createElement('div');
  duplicateStat.className = 'stat-card';
  duplicateStat.innerHTML = `
    <div class="stat-label">Duplicate Records</div>
    <div class="stat-value">${duplicateRecords.length}</div>
  `;
  reportDataQuality.appendChild(duplicateStat);
  
  const validStat = document.createElement('div');
  validStat.className = 'stat-card';
  validStat.innerHTML = `
    <div class="stat-label">Valid Records</div>
    <div class="stat-value">${stats.totalRecords}</div>
  `;
  reportDataQuality.appendChild(validStat);
  
  // Update top reasons table
  const topReasonsTable = document.getElementById('topReasonsTable');
  topReasonsTable.innerHTML = '';
  
  const reasonCounts = {};
  transactions.forEach(t => {
    reasonCounts[t.reason] = (reasonCounts[t.reason] || 0) + 1;
  });
  
  const sortedReasons = Object.entries(reasonCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  sortedReasons.forEach(([reason, count]) => {
    const percent = ((count / stats.totalRecords) * 100).toFixed(1);
    
    const row = topReasonsTable.insertRow();
    row.insertCell(0).textContent = reason;
    row.insertCell(1).textContent = count;
    row.insertCell(2).textContent = `${percent}%`;
  });
  
  // Update top branches table
  const topBranchesTable = document.getElementById('topBranchesTable');
  topBranchesTable.innerHTML = '';
  
  const branchDeductions = {};
  transactions.forEach(t => {
    if (!branchDeductions[t.area]) {
      branchDeductions[t.area] = 0;
    }
    branchDeductions[t.area] += Math.abs(t.amount);
  });
  
  const sortedBranches = Object.entries(branchDeductions)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  sortedBranches.forEach(([branch, amount]) => {
    const percent = ((amount / stats.totalDeductions) * 100).toFixed(1);
    
    const row = topBranchesTable.insertRow();
    row.insertCell(0).textContent = branch;
    row.insertCell(1).textContent = formatCurrency(amount);
    row.insertCell(2).textContent = `${percent}%`;
  });
  
  // Show report modal
  document.getElementById('reportModal').style.display = 'block';
}

// Close report modal
function closeReport() {
  document.getElementById('reportModal').style.display = 'none';
}

// Print report
function printReport() {
  window.print();
}

// Export report to PDF
function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Add title
  doc.setFontSize(20);
  doc.text('Careem Clawback Management Report', 105, 15, { align: 'center' });
  
  // Add date
  doc.setFontSize(12);
  const dateStr = new Date().toLocaleDateString();
  doc.text(`Generated on: ${dateStr}`, 105, 25, { align: 'center' });
  
  // Add financial summary
  doc.setFontSize(16);
  doc.text('Financial Summary', 20, 40);
  
  const stats = calculateStats();
  
  doc.setFontSize(12);
  doc.text(`Total Clawbacks: ${formatCurrency(stats.totalClawbacks)}`, 20, 50);
  doc.text(`Total Penalties: ${formatCurrency(stats.totalPenalties)}`, 20, 58);
  doc.text(`Total Compensated: ${formatCurrency(stats.totalCompensated)}`, 20, 66);
  doc.text(`Main Disputes: ${stats.totalDisputes}`, 20, 74);
  doc.text(`Net Amount: ${formatCurrency(stats.netAmount)}`, 20, 82);
  
  // Add executive summary
  doc.setFontSize(16);
  doc.text('Executive Summary', 20, 100);
  
  doc.setFontSize(12);
  doc.text(`Total Transactions: ${stats.totalRecords}`, 20, 110);
  doc.text(`Total Deductions: ${formatCurrency(stats.totalDeductions)}`, 20, 118);
  doc.text(`Average per Transaction: ${formatCurrency(stats.averageRecord)}`, 20, 126);
  doc.text(`Refunded Amount: ${formatCurrency(stats.refundedAmount)}`, 20, 134);
  doc.text(`Compensated Amount: ${formatCurrency(stats.compensatedAmount)}`, 20, 142);
  
  // Save the PDF
  doc.save('careem_clawback_report.pdf');
  showNotification('Report exported to PDF', 'success');
}

// Clear all data with confirmation
function clearAllData() {
  showConfirmDialog(
    'Are you sure you want to clear all data? This action cannot be undone.',
    function() {
      transactions = [];
      invalidRecords = [];
      duplicateRecords = [];
      updateUI();
      saveToLocalStorage();
      showNotification('All data cleared', 'success');
      console.log('All data cleared');
    }
  );
}

// Toggle dark mode
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDarkMode = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDarkMode);
  showNotification(`Dark mode ${isDarkMode ? 'enabled' : 'disabled'}`, 'success');
}

// Apply filters to the table
function applyFilters() {
  const refIdFilter = document.getElementById('filterRefId').value.toLowerCase();
  const idFilter = document.getElementById('filterId').value.toLowerCase();
  const areaFilter = document.getElementById('filterArea').value.toLowerCase();
  const statusFilter = document.getElementById('filterStatus').value;
  const categoryFilter = document.getElementById('filterCategory').value;
  const reasonFilter = selectedReason;
  const dateFromFilter = document.getElementById('filterDateFrom').value;
  const dateToFilter = document.getElementById('filterDateTo').value;
  
  const filteredTransactions = transactions.filter(t => {
    // Reference ID filter
    if (refIdFilter && !t.referenceId.toLowerCase().includes(refIdFilter)) {
      return false;
    }
    
    // Billable ID filter
    if (idFilter && !t.id.toLowerCase().includes(idFilter)) {
      return false;
    }
    
    // Area filter
    if (areaFilter && !t.area.toLowerCase().includes(areaFilter)) {
      return false;
    }
    
    // Status filter
    if (statusFilter && t.status !== statusFilter) {
      return false;
    }
    
    // Category filter
    if (categoryFilter && t.category !== categoryFilter) {
      return false;
    }
    
    // Reason filter
    if (reasonFilter && t.reason !== reasonFilter) {
      return false;
    }
    
    // Date from filter
    if (dateFromFilter && t.date < new Date(dateFromFilter)) {
      return false;
    }
    
    // Date to filter
    if (dateToFilter && t.date > new Date(dateToFilter)) {
      return false;
    }
    
    return true;
  });
  
  updateTable(filteredTransactions);
}

// Sort table by column
function sortTable(column) {
  if (sortColumn === column) {
    sortAscending = !sortAscending;
  } else {
    sortColumn = column;
    sortAscending = true;
  }
  
  const sortedTransactions = [...transactions].sort((a, b) => {
    let valueA = a[column];
    let valueB = b[column];
    
    // Handle dates
    if (column === 'date') {
      valueA = valueA.getTime();
      valueB = valueB.getTime();
    }
    
    // Handle amounts
    if (column === 'amount') {
      valueA = parseFloat(valueA);
      valueB = parseFloat(valueB);
    }
    
    // Handle strings
    if (typeof valueA === 'string') {
      valueA = valueA.toLowerCase();
      valueB = valueB.toLowerCase();
    }
    
    if (valueA < valueB) {
      return sortAscending ? -1 : 1;
    }
    if (valueA > valueB) {
      return sortAscending ? 1 : -1;
    }
    return 0;
  });
  
  // Update sort indicators
  const headers = document.querySelectorAll('#dataTable th');
  headers.forEach(header => {
    header.classList.remove('sorted-asc', 'sorted-desc');
    if (header.getAttribute('onclick').includes(column)) {
      header.classList.add(sortAscending ? 'sorted-asc' : 'sorted-desc');
    }
  });
  
  updateTable(sortedTransactions);
}

// Toggle reason dropdown
function toggleReasonDropdown() {
  const dropdown = document.getElementById('reasonDropdown');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// Update reasons dropdown
function updateReasonsDropdown() {
  const dropdown = document.getElementById('reasonDropdown');
  dropdown.innerHTML = '';
  
  // Get all unique reasons
  const uniqueReasons = [...new Set(transactions.map(t => t.reason))];
  
  // Add "All" option
  const allOption = document.createElement('div');
  allOption.className = 'reason-option';
  allOption.textContent = 'All Reasons';
  allOption.onclick = function() {
    selectedReason = '';
    document.getElementById('filterReason').value = 'All Reasons';
    dropdown.style.display = 'none';
    applyFilters();
  };
  dropdown.appendChild(allOption);
  
  // Add reason options
  uniqueReasons.forEach(reason => {
    const option = document.createElement('div');
    option.className = 'reason-option';
    option.textContent = reason;
    option.onclick = function() {
      selectedReason = reason;
      document.getElementById('filterReason').value = reason;
      dropdown.style.display = 'none';
      applyFilters();
    };
    dropdown.appendChild(option);
  });
}

// Update UI with current data
function updateUI() {
  // Calculate statistics
  const stats = calculateStats();
  
  // Update summary cards
  document.getElementById('totalClawbacks').textContent = formatCurrency(stats.totalClawbacks);
  document.getElementById('totalPenalties').textContent = formatCurrency(stats.totalPenalties);
  document.getElementById('totalCompensated').textContent = formatCurrency(stats.totalCompensated);
  document.getElementById('totalDisputes').textContent = stats.totalDisputes;
  document.getElementById('netAmount').textContent = formatCurrency(stats.netAmount);
  
  // Update dashboard stats
  document.getElementById('totalRecords').textContent = stats.totalRecords;
  document.getElementById('totalDeductions').textContent = formatCurrency(stats.totalDeductions);
  document.getElementById('averageRecord').textContent = formatCurrency(stats.averageRecord);
  document.getElementById('refundedAmount').textContent = formatCurrency(stats.refundedAmount);
  document.getElementById('compensatedAmount').textContent = formatCurrency(stats.compensatedAmount);
  
  // Update error stats
  document.getElementById('invalidCount').textContent = invalidRecords.length;
  document.getElementById('duplicateCount').textContent = duplicateRecords.length;
  document.getElementById('validCount').textContent = stats.totalRecords;
  
  // Show/hide error stats section
  const errorStatsSection = document.getElementById('errorStats');
  if (invalidRecords.length > 0 || duplicateRecords.length > 0) {
    errorStatsSection.style.display = 'flex';
  } else {
    errorStatsSection.style.display = 'none';
  }
  
  // Update reasons breakdown
  updateReasonsBreakdown();
  
  // Update tables
  updateTable(transactions);
  updateBranchTable();
  
  // Update analysis
  updateAnalysis();
  
  // Update reasons dropdown
  updateReasonsDropdown();
  
  // Show/hide invalid records section
  const invalidRecordsSection = document.getElementById('invalidRecordsSection');
  if (invalidRecords.length > 0) {
    invalidRecordsSection.style.display = 'block';
    updateInvalidRecordsTable();
  } else {
    invalidRecordsSection.style.display = 'none';
  }
}

// Calculate statistics
function calculateStats() {
  const stats = {
    totalRecords: transactions.length,
    totalDeductions: 0,
    totalClawbacks: 0,
    totalPenalties: 0,
    totalCompensated: 0,
    totalDisputes: 0,
    refundedAmount: 0,
    compensatedAmount: 0,
    averageRecord: 0,
    netAmount: 0
  };
  
  transactions.forEach(t => {
    const absAmount = Math.abs(t.amount);
    stats.totalDeductions += absAmount;
    
    if (t.category === 'CLAWBACK') {
      stats.totalClawbacks += absAmount;
      if (t.status === 'Refunded') {
        stats.refundedAmount += absAmount;
      }
    } else if (t.category === 'PENALTY') {
      stats.totalPenalties += absAmount;
    } else if (t.category === 'COMPENSATED') {
      stats.totalCompensated += absAmount;
      stats.compensatedAmount += absAmount;
    }
    
    if (mainDisputeReasons.includes(t.reason)) {
      stats.totalDisputes++;
    }
  });
  
  stats.averageRecord = stats.totalRecords > 0 ? stats.totalDeductions / stats.totalRecords : 0;
  stats.netAmount = stats.totalCompensated - stats.totalDeductions;
  
  return stats;
}

// Update reasons breakdown
function updateReasonsBreakdown() {
  const reasonsList = document.getElementById('reasonsList');
  reasonsList.innerHTML = '';
  
  // Count reasons
  const reasonCounts = {};
  transactions.forEach(t => {
    reasonCounts[t.reason] = (reasonCounts[t.reason] || 0) + 1;
  });
  
  // Sort by count
  const sortedReasons = Object.entries(reasonCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);
  
  if (sortedReasons.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'No data available';
    reasonsList.appendChild(li);
    return;
  }
  
  sortedReasons.forEach(([reason, count]) => {
    const li = document.createElement('li');
    
    const reasonSpan = document.createElement('span');
    reasonSpan.className = 'reason';
    reasonSpan.textContent = reason;
    
    const countSpan = document.createElement('span');
    countSpan.textContent = ` (${count})`;
    
    li.appendChild(reasonSpan);
    li.appendChild(countSpan);
    
    // Add class for main disputes
    if (mainDisputeReasons.includes(reason)) {
      li.classList.add('main-dispute');
    }
    
    reasonsList.appendChild(li);
  });
}

// Update transactions table
function updateTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  
  if (data.length === 0) {
    const row = tbody.insertRow();
    const cell = row.insertCell();
    cell.colSpan = 9;
    cell.textContent = 'No transactions found';
    return;
  }
  
  data.forEach(t => {
    const row = tbody.insertRow();
    
    // Reference ID
    const refIdCell = row.insertCell();
    refIdCell.textContent = t.referenceId;
    
    // Billable ID
    const idCell = row.insertCell();
    idCell.textContent = t.id;
    
    // Date
    const dateCell = row.insertCell();
    dateCell.textContent = t.date.toLocaleDateString();
    
    // Amount
    const amountCell = row.insertCell();
    amountCell.textContent = formatCurrency(t.amount);
    if (t.amount < 0) {
      amountCell.classList.add('negative');
    }
    
    // Description
    const descCell = row.insertCell();
    descCell.textContent = t.description;
    
    // Area
    const areaCell = row.insertCell();
    areaCell.textContent = t.area;
    
    // Category
    const categoryCell = row.insertCell();
    const categoryBadge = document.createElement('span');
    categoryBadge.className = `category-badge ${t.category.toLowerCase()}`;
    categoryBadge.textContent = t.category;
    categoryCell.appendChild(categoryBadge);
    
    // Status
    const statusCell = row.insertCell();
    statusCell.textContent = t.status;
    
    // Action
    const actionCell = row.insertCell();
    
    // Create status dropdown
    const statusSelect = document.createElement('select');
    statusSelect.className = 'action-select';
    statusSelect.dataset.referenceId = t.referenceId;
    
    // Add status options
    const statusOptions = ['Refunded', 'Compensated', 'Charged', 'Pending', 'Resolved'];
    statusOptions.forEach(option => {
      const optionElement = document.createElement('option');
      optionElement.value = option;
      optionElement.textContent = option;
      if (option === t.status) {
        optionElement.selected = true;
      }
      statusSelect.appendChild(optionElement);
    });
    
    // Add change event listener
    statusSelect.addEventListener('change', function() {
      changeStatus(this.dataset.referenceId, this.value);
    });
    
    actionCell.appendChild(statusSelect);
  });
}

// Update branch table
function updateBranchTable() {
  const tbody = document.querySelector('#branchTable tbody');
  tbody.innerHTML = '';
  
  // Group by area
  const branchData = {};
  transactions.forEach(t => {
    if (!branchData[t.area]) {
      branchData[t.area] = {
        orderCount: 0,
        totalDeductions: 0,
        reasons: {}
      };
    }
    
    branchData[t.area].orderCount++;
    branchData[t.area].totalDeductions += Math.abs(t.amount);
    
    if (!branchData[t.area].reasons[t.reason]) {
      branchData[t.area].reasons[t.reason] = 0;
    }
    branchData[t.area].reasons[t.reason]++;
  });
  
  // Sort by total deductions
  const sortedBranches = Object.entries(branchData)
    .sort((a, b) => b[1].totalDeductions - a[1].totalDeductions);
  
  sortedBranches.forEach(([area, data]) => {
    const row = tbody.insertRow();
    
    // Branch
    const areaCell = row.insertCell();
    areaCell.textContent = area;
    
    // Order count
    const countCell = row.insertCell();
    countCell.textContent = data.orderCount;
    
    // Total deductions
    const deductionsCell = row.insertCell();
    deductionsCell.textContent = formatCurrency(data.totalDeductions);
    
    // Reasons
    const reasonsCell = row.insertCell();
    const reasonsList = Object.entries(data.reasons)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([reason, count]) => `${reason} (${count})`)
      .join(', ');
    reasonsCell.textContent = reasonsList;
  });
}

// Update invalid records table
function updateInvalidRecordsTable() {
  const tbody = document.getElementById('invalidRecordsTable');
  tbody.innerHTML = '';
  
  invalidRecords.forEach(r => {
    const row = tbody.insertRow();
    
    // Line #
    const lineCell = row.insertCell();
    lineCell.textContent = r.line;
    
    // Original data
    const dataCell = row.insertCell();
    dataCell.textContent = r.originalData;
    
    // Error reason
    const errorCell = row.insertCell();
    errorCell.className = 'error-reason';
    errorCell.textContent = r.error;
    
    // Details
    const detailsCell = row.insertCell();
    detailsCell.className = 'error-details';
    detailsCell.textContent = r.details;
  });
}

// Update analysis report
function updateAnalysis() {
  const stats = calculateStats();
  
  // Executive Summary
  const executiveSummary = document.getElementById('executiveSummary');
  if (stats.totalRecords > 0) {
    executiveSummary.innerHTML = `
      <p>This report analyzes <span class="highlight">${stats.totalRecords}</span> clawback transactions 
      totaling <span class="negative-highlight">${formatCurrency(stats.totalDeductions)}</span> in deductions.</p>
      <p>Of these, <span class="highlight">${stats.totalDisputes}</span> transactions (${((stats.totalDisputes / stats.totalRecords) * 100).toFixed(1)}%) 
      were identified as main disputes that Careem accepts for refunds.</p>
      <p>The average deduction per transaction is <span class="negative-highlight">${formatCurrency(stats.averageRecord)}</span>.</p>
    `;
  } else {
    executiveSummary.innerHTML = '<p>No data available. Please import data to generate analysis.</p>';
  }
  
  // Main Dispute Reasons Analysis
  const disputeAnalysis = document.getElementById('disputeAnalysis');
  if (stats.totalDisputes > 0) {
    const disputeCounts = {};
    transactions.forEach(t => {
      if (mainDisputeReasons.includes(t.reason)) {
        disputeCounts[t.reason] = (disputeCounts[t.reason] || 0) + 1;
      }
    });
    
    const topDisputes = Object.entries(disputeCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3);
    
    let disputeHtml = '<p>The top main dispute reasons are:</p><ul>';
    topDisputes.forEach(([reason, count]) => {
      const percent = ((count / stats.totalDisputes) * 100).toFixed(1);
      disputeHtml += `<li><span class="dispute-highlight">${reason}</span>: ${count} disputes (${percent}%)</li>`;
    });
    disputeHtml += '</ul>';
    
    disputeAnalysis.innerHTML = disputeHtml;
  } else {
    disputeAnalysis.innerHTML = '<p>No main dispute reasons identified. All transactions appear to be penalties or other deductions.</p>';
  }
  
  // Financial Impact Analysis
  const financialAnalysis = document.getElementById('financialAnalysis');
  if (stats.totalRecords > 0) {
    const clawbackPercent = ((stats.totalClawbacks / stats.totalDeductions) * 100).toFixed(1);
    const penaltyPercent = ((stats.totalPenalties / stats.totalDeductions) * 100).toFixed(1);
    const compensatedPercent = ((stats.totalCompensated / stats.totalDeductions) * 100).toFixed(1);
    
    financialAnalysis.innerHTML = `
      <p>Clawbacks account for <span class="negative-highlight">${clawbackPercent}%</span> of total deductions 
      (<span class="negative-highlight">${formatCurrency(stats.totalClawbacks)}</span>).</p>
      <p>Penalties make up <span class="negative-highlight">${penaltyPercent}%</span> of total deductions 
      (<span class="negative-highlight">${formatCurrency(stats.totalPenalties)}</span>).</p>
      <p>Compensated amounts represent <span class="highlight">${compensatedPercent}%</span> of total deductions 
      (<span class="highlight">${formatCurrency(stats.totalCompensated)}</span>).</p>
      <p>The net financial impact is <span class="${stats.netAmount >= 0 ? 'highlight' : 'negative-highlight'}">${formatCurrency(stats.netAmount)}</span>.</p>
    `;
  } else {
    financialAnalysis.innerHTML = '<p>No financial data available. Please import data to generate analysis.</p>';
  }
  
  // Branch Performance Analysis
  const branchAnalysis = document.getElementById('branchAnalysis');
  if (stats.totalRecords > 0) {
    const branchData = {};
    transactions.forEach(t => {
      if (!branchData[t.area]) {
        branchData[t.area] = {
          orderCount: 0,
          totalDeductions: 0,
          disputeCount: 0
        };
      }
      
      branchData[t.area].orderCount++;
      branchData[t.area].totalDeductions += Math.abs(t.amount);
      
      if (mainDisputeReasons.includes(t.reason)) {
        branchData[t.area].disputeCount++;
      }
    });
    
    const topBranches = Object.entries(branchData)
      .sort((a, b) => b[1].totalDeductions - a[1].totalDeductions)
      .slice(0, 3);
    
    let branchHtml = '<p>The top 3 branches by deduction amount are:</p><ul>';
    topBranches.forEach(([area, data]) => {
      const disputePercent = data.orderCount > 0 ? ((data.disputeCount / data.orderCount) * 100).toFixed(1) : 0;
      branchHtml += `<li><strong>${area}</strong>: ${data.orderCount} orders, ${formatCurrency(data.totalDeductions)} deductions, ${data.disputeCount} disputes (${disputePercent}%)</li>`;
    });
    branchHtml += '</ul>';
    
    branchAnalysis.innerHTML = branchHtml;
  } else {
    branchAnalysis.innerHTML = '<p>No branch data available. Please import data to generate analysis.</p>';
  }
  
  // Recommendations
  const recommendations = document.getElementById('recommendations');
  if (stats.totalRecords > 0) {
    let recHtml = '<ul>';
    
    if (stats.totalDisputes / stats.totalRecords > 0.3) {
      recHtml += '<li>High dispute rate detected. Focus on improving food quality and order accuracy to reduce valid customer complaints.</li>';
    }
    
    if (stats.totalPenalties / stats.totalDeductions > 0.2) {
      recHtml += '<li>Significant penalties identified. Review operations to ensure compliance with Careem policies.</li>';
    }
    
    if (stats.totalClawbacks / stats.totalDeductions > 0.7) {
      recHtml += '<li>Majority of deductions are clawbacks. Implement better quality control measures to reduce customer complaints.</li>';
    }
    
    recHtml += '<li>Regularly analyze this data to identify trends and take proactive measures.</li>';
    recHtml += '<li>Train staff on common dispute reasons to prevent recurring issues.</li>';
    recHtml += '</ul>';
    
    recommendations.innerHTML = recHtml;
  } else {
    recommendations.innerHTML = '<p>No recommendations available. Please import data to generate analysis.</p>';
  }
}

// Change transaction status
function changeStatus(referenceId, newStatus) {
  // Find the transaction
  const transaction = transactions.find(t => t.referenceId === referenceId);
  if (!transaction) {
    showNotification('Transaction not found', 'error');
    return;
  }
  
  // Update the status
  transaction.status = newStatus;
  
  // If status is changed to Compensated, update category
  if (newStatus === 'Compensated') {
    transaction.category = 'COMPENSATED';
  }
  
  // Save to localStorage
  saveToLocalStorage();
  
  // Update UI
  updateUI();
  
  // Show notification
  showNotification(`Status updated to ${newStatus}`, 'success');
  console.log(`Status updated for transaction ${referenceId} to ${newStatus}`);
}

// Format currency
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-AE', {
    style: 'currency',
    currency: 'AED',
    minimumFractionDigits: 2
  }).format(amount);
}

// Show notification
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = 'notification show';
  
  if (type === 'error') {
    notification.classList.add('error');
  } else if (type === 'warning') {
    notification.style.background = '#f39c12';
  } else if (type === 'info') {
    notification.style.background = '#3498db';
  } else {
    notification.style.background = '';
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Show confirmation dialog
function showConfirmDialog(message, onConfirm) {
  const dialog = document.getElementById('confirmDialog');
  const messageElement = document.getElementById('confirmMessage');
  const yesButton = document.getElementById('confirmYes');
  const noButton = document.getElementById('confirmNo');
  
  messageElement.textContent = message;
  dialog.style.display = 'flex';
  
  // Remove previous event listeners
  const newYesButton = yesButton.cloneNode(true);
  yesButton.parentNode.replaceChild(newYesButton, yesButton);
  
  const newNoButton = noButton.cloneNode(true);
  noButton.parentNode.replaceChild(newNoButton, noButton);
  
  // Add event listeners
  document.getElementById('confirmYes').addEventListener('click', function() {
    dialog.style.display = 'none';
    onConfirm();
  });
  
  document.getElementById('confirmNo').addEventListener('click', function() {
    dialog.style.display = 'none';
  });
}

// Save data to localStorage
function saveToLocalStorage() {
  const data = {
    transactions,
    invalidRecords,
    duplicateRecords
  };
  localStorage.setItem('careemClawbackData', JSON.stringify(data));
  console.log('Data saved to localStorage');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
  const reasonFilter = document.querySelector('.reason-filter');
  const reasonDropdown = document.getElementById('reasonDropdown');
  
  if (!reasonFilter.contains(event.target)) {
    reasonDropdown.style.display = 'none';
  }
});
</script>
</body>
</html>
