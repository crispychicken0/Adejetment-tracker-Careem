<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Careem Clawback Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --primary: #4CAF50;
    --secondary: #2196F3;
    --bg-light: #f9f9f9;
    --bg-dark: #333;
    --text-light: #333;
    --text-dark: #fff;
  }
  body { 
    font-family: 'Segoe UI', Arial, sans-serif; 
    margin: 20px; 
    background: var(--bg-light); 
    color: var(--text-light); 
    transition: background 0.3s, color 0.3s;
  }
  body.dark-mode {
    background: var(--bg-dark);
    color: var(--text-dark);
  }
  h2, h3 { margin-bottom: 15px; font-weight: 500; }
  .container { 
    max-width: 1200px; 
    margin: 0 auto; 
    display: grid; 
    gap: 20px; 
  }
  .dashboard { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 15px; 
    margin-bottom: 20px; 
  }
  .dashboard-card { 
    background: #fff; 
    border-radius: 8px; 
    padding: 15px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    text-align: center; 
  }
  body.dark-mode .dashboard-card {
    background: #444;
  }
  .dashboard-card h4 { 
    margin: 0 0 10px; 
    font-size: 1.1em; 
    color: var(--primary); 
  }
  .dashboard-card p { 
    margin: 0; 
    font-size: 1.5em; 
    font-weight: bold; 
  }
  .reasons-card { 
    text-align: left; 
    max-height: 200px; 
    overflow-y: auto; 
  }
  .reasons-card ul { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
  }
  .reasons-card li { 
    padding: 5px 0; 
    border-bottom: 1px solid #eee; 
  }
  body.dark-mode .reasons-card li {
    border-bottom: 1px solid #555;
  }
  .reasons-card li:last-child { 
    border-bottom: none; 
  }
  .reasons-card .reason { 
    font-weight: bold; 
  }
  table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-top: 20px; 
    background: #fff; 
    border-radius: 8px; 
    overflow: hidden; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
  }
  body.dark-mode table {
    background: #444;
    color: #fff;
  }
  th, td { 
    border: 1px solid #ddd; 
    padding: 10px; 
    text-align: center; 
  }
  body.dark-mode th, body.dark-mode td {
    border-color: #555;
  }
  th { 
    background: #f4f4f4; 
    cursor: pointer; 
    font-weight: bold; 
  }
  body.dark-mode th {
    background: #555;
  }
  th:hover { 
    background: #e0e0e0; 
  }
  body.dark-mode th:hover {
    background: #666;
  }
  .negative { 
    color: #e74c3c; 
    font-weight: bold; 
  }
  .controls { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
  }
  input, textarea, select { 
    padding: 8px; 
    border: 1px solid #ddd; 
    border-radius: 4px; 
    width: 100%; 
    box-sizing: border-box; 
  }
  body.dark-mode input, 
  body.dark-mode textarea, 
  body.dark-mode select {
    background: #555;
    color: #fff;
    border-color: #666;
  }
  textarea { 
    resize: vertical; 
  }
  button { 
    background: var(--primary); 
    color: white; 
    border: none; 
    padding: 8px 16px; 
    cursor: pointer; 
    border-radius: 4px; 
    transition: background 0.2s; 
  }
  button:disabled { 
    background: #ccc; 
    cursor: not-allowed; 
  }
  button:hover:not(:disabled) { 
    background: #45a049; 
  }
  .section { 
    margin-top: 40px; 
    padding-top: 20px; 
    border-top: 2px solid #ddd; 
  }
  body.dark-mode .section {
    border-top: 2px solid #555;
  }
  .notification { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    padding: 10px 20px; 
    background: #4CAF50; 
    color: white; 
    border-radius: 4px; 
    display: none; 
    z-index: 1000; 
    opacity: 0; 
    transition: opacity 0.5s;
  }
  .notification.show { 
    opacity: 1; 
    display: block; 
  }
  .notification.error { 
    background: #e74c3c; 
  }
  canvas { 
    max-width: 100%; 
    margin-top: 20px; 
    background: #fff; 
    border-radius: 8px; 
    padding: 10px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
  }
  body.dark-mode canvas {
    background: #444;
  }
  .stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: #f0f0f0;
    border-radius: 4px;
    padding: 10px;
    flex: 1;
    min-width: 150px;
  }
  body.dark-mode .stat-card {
    background: #555;
  }
  .stat-label {
    font-size: 0.9em;
    color: #666;
  }
  body.dark-mode .stat-label {
    color: #ccc;
  }
  .stat-value {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--primary);
  }
  .report-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .report-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }
  body.dark-mode .report-content {
    background-color: #444;
    color: #fff;
  }
  .close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .close:hover {
    color: #e74c3c;
  }
  .report-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #ddd;
  }
  body.dark-mode .report-header {
    border-bottom: 2px solid #555;
  }
  .report-section {
    margin-bottom: 25px;
  }
  .report-section h3 {
    margin-bottom: 15px;
    color: var(--primary);
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
  }
  body.dark-mode .report-section h3 {
    border-bottom: 1px solid #555;
  }
  .report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  .report-table th, .report-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  body.dark-mode .report-table th, body.dark-mode .report-table td {
    border-bottom: 1px solid #555;
  }
  .report-table th {
    background-color: #f5f5f5;
    font-weight: bold;
  }
  body.dark-mode .report-table th {
    background-color: #555;
  }
  .report-chart {
    margin: 20px 0;
    text-align: center;
  }
  .report-footer {
    text-align: center;
    margin-top: 30px;
    padding-top: 15px;
    border-top: 2px solid #ddd;
    font-size: 0.9em;
    color: #666;
  }
  body.dark-mode .report-footer {
    border-top: 2px solid #555;
    color: #ccc;
  }
  .error-table {
    margin-top: 20px;
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  body.dark-mode .error-table {
    background: #444;
  }
  .error-table th, .error-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  body.dark-mode .error-table th, body.dark-mode .error-table td {
    border-color: #555;
  }
  .error-table th {
    background-color: #f5f5f5;
    font-weight: bold;
  }
  body.dark-mode .error-table th {
    background-color: #555;
  }
  .error-reason {
    color: #e74c3c;
    font-weight: bold;
  }
  .error-details {
    font-size: 0.9em;
    color: #666;
  }
  body.dark-mode .error-details {
    color: #ccc;
  }
  .error-stats {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .error-stat {
    background: #ffebee;
    border-radius: 4px;
    padding: 10px;
    flex: 1;
    text-align: center;
  }
  body.dark-mode .error-stat {
    background: #555;
  }
  .error-stat-label {
    font-size: 0.9em;
    color: #666;
  }
  body.dark-mode .error-stat-label {
    color: #ccc;
  }
  .error-stat-value {
    font-size: 1.2em;
    font-weight: bold;
    color: #e74c3c;
  }
  .reason-filter {
    position: relative;
  }
  .reason-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }
  body.dark-mode .reason-dropdown {
    background: #444;
    border-color: #555;
  }
  .reason-option {
    padding: 8px 12px;
    cursor: pointer;
  }
  .reason-option:hover {
    background: #f0f0f0;
  }
  body.dark-mode .reason-option:hover {
    background: #555;
  }
  .reason-option.selected {
    background: var(--primary);
    color: white;
  }
  @media (max-width: 600px) {
    table { 
      display: block; 
      overflow-x: auto; 
    }
    .controls { 
      flex-direction: column; 
    }
    .dashboard { 
      grid-template-columns: 1fr; 
    }
    .stats-container {
      flex-direction: column;
    }
    .report-content {
      width: 95%;
      margin: 10% auto;
    }
  }
</style>
</head>

<body>

<div class="container">
  <h2>Careem Clawback Tracker</h2>

  <div class="section">
    <h3>Import Data</h3>
    <textarea id="rawData" rows="6" placeholder="Paste clawback data here (e.g., REF123&#9;BILL456&#9;9/16/2025&#9;-50.00&#9;Food__Customer__Quality Issues__Food is overcooked/burnt&#9;CLAWBACK&#9;Downtown Dubai)"></textarea>
    <input type="file" id="csvFile" accept=".csv" onchange="importFromCSV()">
    <div class="controls">
      <button onclick="importData()">Import Data</button>
      <button onclick="exportToCSV()">Export to CSV</button>
      <button onclick="exportInvalidRecords()">Export Invalid Records</button>
      <button onclick="generateReport()">Generate Management Report</button>
      <button onclick="clearFilters()">Clear Filters</button>
      <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
      <button onclick="toggleReasonConsolidation()">Toggle Consolidated Reasons</button>
    </div>
  </div>

  <div class="section">
    <h3>Dashboard</h3>
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">Total Records</div>
        <div class="stat-value" id="totalRecords">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Deductions</div>
        <div class="stat-value" id="totalDeductions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average per Record</div>
        <div class="stat-value" id="averageRecord">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Refunded Amount</div>
        <div class="stat-value" id="refundedAmount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Compensated Amount</div>
        <div class="stat-value" id="compensatedAmount">0</div>
      </div>
    </div>
    
    <div id="errorStats" class="error-stats" style="display: none;">
      <div class="error-stat">
        <div class="error-stat-label">Invalid Records</div>
        <div class="error-stat-value" id="invalidCount">0</div>
      </div>
      <div class="error-stat">
        <div class="error-stat-label">Duplicate Records</div>
        <div class="error-stat-value" id="duplicateCount">0</div>
      </div>
      <div class="error-stat">
        <div class="error-stat-label">Valid Records</div>
        <div class="error-stat-value" id="validCount">0</div>
      </div>
    </div>
    
    <div class="dashboard" id="reasonsBreakdown">
      <div class="dashboard-card reasons-card">
        <h4>Reasons Breakdown</h4>
        <ul id="reasonsList">
          <li>No data available</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="section" id="invalidRecordsSection" style="display: none;">
    <h3>Invalid Records</h3>
    <table class="error-table">
      <thead>
        <tr>
          <th>Line #</th>
          <th>Original Data</th>
          <th>Error Reason</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="invalidRecordsTable"></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Filters</h3>
    <div class="controls">
      <label>Reference ID: <input type="text" id="filterRefId" onkeyup="applyFilters()"></label>
      <label>Billable ID: <input type="text" id="filterId" onkeyup="applyFilters()"></label>
      <label>Merchant Area: <input type="text" id="filterArea" onkeyup="applyFilters()"></label>
      <label>Status: 
        <select id="filterStatus" onchange="applyFilters()">
          <option value="">All</option>
          <option value="Refunded">Refunded</option>
          <option value="Compensated">Compensated</option>
        </select>
      </label>
      <label>Reason: 
        <div class="reason-filter">
          <input type="text" id="filterReason" placeholder="Select or type reason" readonly onclick="toggleReasonDropdown()">
          <div class="reason-dropdown" id="reasonDropdown"></div>
        </div>
      </label>
      <label>From Date: <input type="date" id="filterDateFrom" onchange="applyFilters()"></label>
      <label>To Date: <input type="date" id="filterDateTo" onchange="applyFilters()"></label>
    </div>
  </div>

  <div class="section">
    <h3>Transactions</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th onclick="sortTable('referenceId')">Reference ID</th>
          <th onclick="sortTable('id')">Billable ID</th>
          <th onclick="sortTable('date')">Date</th>
          <th onclick="sortTable('amount')">Amount</th>
          <th onclick="sortTable('description')">Description</th>
          <th onclick="sortTable('area')">Merchant Area</th>
          <th onclick="sortTable('status')">Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Branch Summary (Orders and Reasons per Branch)</h3>
    <table id="branchTable">
      <thead>
        <tr>
          <th>Branch</th>
          <th>Order Count</th>
          <th>Reasons</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Total Deductions by Branch</h3>
    <canvas id="deductionsChart"></canvas>
  </div>

  <div class="section">
    <h3>Reasons Distribution</h3>
    <canvas id="reasonsChart"></canvas>
  </div>
</div>

<div class="notification" id="notification"></div>

<!-- Report Modal -->
<div id="reportModal" class="report-modal">
  <div class="report-content" id="reportContent">
    <span class="close" onclick="closeReport()">&times;</span>
    <div class="report-header">
      <h2>Careem Clawback Management Report</h2>
      <p id="reportDate"></p>
    </div>
    <div class="report-section">
      <h3>Executive Summary</h3>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">Total Transactions</div>
          <div class="stat-value" id="reportTotalRecords">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Deductions</div>
          <div class="stat-value" id="reportTotalDeductions">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average per Transaction</div>
          <div class="stat-value" id="reportAverageRecord">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Refunded Amount</div>
          <div class="stat-value" id="reportRefundedAmount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Compensated Amount</div>
          <div class="stat-value" id="reportCompensatedAmount">0</div>
        </div>
      </div>
    </div>
    <div class="report-section">
      <h3>Top Reasons for Clawbacks</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Reason</th>
            <th>Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="topReasonsTable"></tbody>
      </table>
    </div>
    <div class="report-section">
      <h3>Top Branches by Deduction Amount</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Branch</th>
            <th>Total Deductions</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody id="topBranchesTable"></tbody>
      </table>
    </div>
    <div class="report-section">
      <h3>Deductions by Branch</h3>
      <div class="report-chart">
        <canvas id="reportDeductionsChart"></canvas>
      </div>
    </div>
    <div class="report-section">
      <h3>Reasons Distribution</h3>
      <div class="report-chart">
        <canvas id="reportReasonsChart"></canvas>
      </div>
    </div>
    <div class="report-footer">
      <p>Generated by Careem Clawback Tracker on <span id="reportFooterDate"></span></p>
    </div>
    <div class="controls">
      <button onclick="printReport()">Print Report</button>
      <button onclick="exportToPDF()">Export as PDF</button>
    </div>
  </div>
</div>

<script>
let transactions = [];
let invalidRecords = [];
let duplicateRecords = [];
let sortColumn = null;
let sortAscending = true;
let deductionsChart = null;
let reasonsChart = null;
let reportDeductionsChart = null;
let reportReasonsChart = null;
let consolidateReasons = false;
let reasonsList = [];
let selectedReason = "";

// Predefined reasons mapping in order
const predefinedReasons = [
  "Food is overcooked/burnt",
  "Missing or unavailable items (Main item)",
  "Wrong item sent",
  "Spilled / damaged",
  "Hair in the food",
  "Foul Smell",
  "My Food is not edible (SelfServe)",
  "Instructions not followed",
  "Penalty for clawback complaint reason",
  "Penalties for Order",
  "Clawback Reversals",
  "Partner Did not Prepare",
  "غرامة إضافية"
];

// Keywords for each predefined reason
const reasonKeywords = {
  "Food is overcooked/burnt": ["overcooked", "burnt", "burnt", "overcooked"],
  "Missing or unavailable items (Main item)": ["missing", "unavailable", "items", "main"],
  "Wrong item sent": ["wrong", "item", "sent"],
  "Spilled / damaged": ["spilled", "damaged"],
  "Hair in the food": ["hair", "food"],
  "Foul Smell": ["foul", "smell"],
  "My Food is not edible (SelfServe)": ["edible", "selfserve"],
  "Instructions not followed": ["instructions", "followed"],
  "Penalty for clawback complaint reason": ["penalty", "clawback", "complaint", "reason"],
  "Penalties for Order": ["penalties", "order"],
  "Clawback Reversals": ["clawback", "reversals"],
  "Partner Did not Prepare": ["partner", "prepare"],
  "غرامة إضافية": ["غرامة", "إضافية", "penalty", "additional"]
};

// Special reason mapping for specific consolidations
const specialReasonMapping = {
  "Penalty for clawback complaint reason": "Penalty for clawback complaint reason",
  "Missing or unavailable items (Main item)": "Missing or unavailable items (Main item)",
  "غرامة إضافية": "Additional Penalty"
};

function mapReason(rawReason) {
  // First check if it's a special mapping
  if (specialReasonMapping[rawReason]) {
    return specialReasonMapping[rawReason];
  }
  
  // Normalize the raw reason
  const normalized = rawReason.toLowerCase().replace(/[^a-z0-9\s]/g, '');
  
  // Check against predefined reasons
  for (const reason of predefinedReasons) {
    const keywords = reasonKeywords[reason];
    for (const keyword of keywords) {
      if (normalized.includes(keyword) || rawReason.includes(keyword)) {
        return reason;
      }
    }
  }
  
  // If no match, return the original reason
  return rawReason;
}

function getReasonOrderIndex(reason) {
  // Return the index of the reason in the predefined list
  return predefinedReasons.indexOf(reason);
}

function formatDate(dateStr) {
  // Convert date format from "9/16/2025" to "2025-09-16"
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    const month = parts[0].padStart(2, '0');
    const day = parts[1].padStart(2, '0');
    const year = parts[2];
    return `${year}-${month}-${day}`;
  }
  return dateStr; // Return original if format doesn't match
}

function showNotification(message, isError = false) {
  const notification = document.getElementById("notification");
  notification.textContent = message;
  notification.className = `notification ${isError ? 'error' : ''} show`;
  setTimeout(() => notification.classList.remove('show'), 3000);
}

function importData() {
  const raw = document.getElementById("rawData").value.trim();
  if (!raw) {
    showNotification("Please enter clawback data.", true);
    return;
  }
  parseData(raw.split("\n"));
}

function importFromCSV() {
  const fileInput = document.getElementById("csvFile");
  const file = fileInput.files[0];
  if (!file) {
    showNotification("Please select a CSV file.", true);
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split("\n").map(line => line.trim()).filter(line => line);
    parseData(lines);
  };
  reader.readAsText(file);
}

function parseData(lines) {
  transactions = [];
  invalidRecords = [];
  duplicateRecords = [];
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  const seenKeys = new Set();
  
  console.log(`Processing ${lines.length} lines of data`);

  for (let i = 0; i < lines.length; i++) {
    const lineNum = i + 1;
    let cols = lines[i].trim().split(/\t/);
    
    // Check for invalid data format
    if (cols.length < 7) {
      invalidRecords.push({
        line: lineNum,
        data: lines[i],
        reason: "Invalid Format",
        details: `Expected 7 columns, got ${cols.length}`
      });
      continue;
    }

    let referenceId = cols[0];
    let billableId = cols[1];
    let date = formatDate(cols[2]);
    let amount = parseFloat(cols[3]);
    
    // Check for invalid amount
    if (isNaN(amount)) {
      invalidRecords.push({
        line: lineNum,
        data: lines[i],
        reason: "Invalid Amount",
        details: `Amount '${cols[3]}' is not a valid number`
      });
      continue;
    }

    // Extract the full description
    let fullDescription = cols[4].replace(/__/g, " ");
    let descriptionParts = cols[4].split('__');
    let rawReason = descriptionParts[descriptionParts.length - 1];
    let description = mapReason(rawReason);

    let category = cols[5];
    let merchantArea = cols[6];

    // Create a unique key that includes the reason for penalty records
    const isPenalty = rawReason.includes("غرامة إضافية") || 
                     rawReason.includes("Penalty") || 
                     rawReason.includes("penalty");
    
    const key = isPenalty 
      ? `${referenceId}-${billableId}-${rawReason}` 
      : `${referenceId}-${billableId}`;

    // Check for duplicates
    if (seenKeys.has(key)) {
      duplicateRecords.push({
        line: lineNum,
        data: lines[i],
        reason: "Duplicate Record",
        details: `Duplicate of line ${Array.from(seenKeys).indexOf(key) + 1}`
      });
      continue;
    }
    seenKeys.add(key);

    transactions.push({
      referenceId: referenceId,
      id: billableId,
      date: date,
      amount: amount,
      description: description,
      rawDescription: fullDescription,
      area: merchantArea,
      status: "Refunded",
      isPenalty: isPenalty
    });
  }

  // Generate unique reasons list
  reasonsList = [...new Set(transactions.map(tx => tx.description))];
  reasonsList.sort((a, b) => getReasonOrderIndex(a) - getReasonOrderIndex(b));
  
  // Populate reason dropdown
  populateReasonDropdown();

  // Display invalid records section if there are any
  if (invalidRecords.length > 0 || duplicateRecords.length > 0) {
    document.getElementById("invalidRecordsSection").style.display = "block";
    document.getElementById("errorStats").style.display = "flex";
    document.getElementById("invalidCount").textContent = invalidRecords.length;
    document.getElementById("duplicateCount").textContent = duplicateRecords.length;
    document.getElementById("validCount").textContent = transactions.length;
    
    // Populate invalid records table
    const invalidTable = document.getElementById("invalidRecordsTable");
    invalidTable.innerHTML = "";
    
    // Add invalid records
    invalidRecords.forEach(record => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${record.line}</td>
        <td class="error-details">${record.data}</td>
        <td class="error-reason">${record.reason}</td>
        <td class="error-details">${record.details}</td>
      `;
      invalidTable.appendChild(row);
    });
    
    // Add duplicate records
    duplicateRecords.forEach(record => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${record.line}</td>
        <td class="error-details">${record.data}</td>
        <td class="error-reason">${record.reason}</td>
        <td class="error-details">${record.details}</td>
      `;
      invalidTable.appendChild(row);
    });
  } else {
    document.getElementById("invalidRecordsSection").style.display = "none";
    document.getElementById("errorStats").style.display = "none";
  }

  if (transactions.length === 0) {
    showNotification(`No valid transactions found. Total rows: ${lines.length}, Invalid: ${invalidRecords.length}, Duplicates: ${duplicateRecords.length}`, true);
  } else {
    saveData();
    renderTable(transactions);
    renderBranchSummary(transactions);
    renderDeductionsChart(transactions);
    renderReasonsChart(transactions);
    updateDashboard(transactions);
    showNotification(`Data imported successfully. Total rows: ${lines.length}, Valid: ${transactions.length}, Invalid: ${invalidRecords.length}, Duplicates: ${duplicateRecords.length}`);
  }
}

function populateReasonDropdown() {
  const dropdown = document.getElementById("reasonDropdown");
  dropdown.innerHTML = "";
  
  // Add "All" option
  const allOption = document.createElement("div");
  allOption.className = "reason-option" + (selectedReason === "" ? " selected" : "");
  allOption.textContent = "All Reasons";
  allOption.onclick = () => selectReason("");
  dropdown.appendChild(allOption);
  
  // Add individual reasons
  reasonsList.forEach(reason => {
    const option = document.createElement("div");
    option.className = "reason-option" + (selectedReason === reason ? " selected" : "");
    option.textContent = reason;
    option.onclick = () => selectReason(reason);
    dropdown.appendChild(option);
  });
}

function toggleReasonDropdown() {
  const dropdown = document.getElementById("reasonDropdown");
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
}

function selectReason(reason) {
  selectedReason = reason;
  document.getElementById("filterReason").value = reason || "All Reasons";
  document.getElementById("reasonDropdown").style.display = "none";
  applyFilters();
}

function updateDashboard(data) {
  let total = 0;
  let statusSummary = { Refunded: 0, Compensated: 0 };
  let reasonSummary = {};

  data.forEach(tx => {
    total += tx.amount;
    statusSummary[tx.status] = (statusSummary[tx.status] || 0) + tx.amount;
    reasonSummary[tx.description] = (reasonSummary[tx.description] || 0) + 1;
  });

  // Update dashboard stats
  document.getElementById("totalRecords").textContent = data.length;
  document.getElementById("totalDeductions").textContent = `(${Math.abs(total).toFixed(2)})`;
  document.getElementById("averageRecord").textContent = `(${data.length ? Math.abs(total / data.length).toFixed(2) : 0})`;
  document.getElementById("refundedAmount").textContent = `(${Math.abs(statusSummary['Refunded'] || 0).toFixed(2)})`;
  document.getElementById("compensatedAmount").textContent = `(${Math.abs(statusSummary['Compensated'] || 0).toFixed(2)})`;

  // Update reasons breakdown - sort by predefined order
  const reasonsListEl = document.getElementById("reasonsList");
  reasonsListEl.innerHTML = "";
  
  const consolidatedReasons = consolidateReasons ? consolidateReasonSummary(reasonSummary) : reasonSummary;
  
  // Sort reasons by predefined order
  const sortedReasons = Object.entries(consolidatedReasons)
    .sort((a, b) => getReasonOrderIndex(a[0]) - getReasonOrderIndex(b[0]))
    .filter(([reason]) => getReasonOrderIndex(reason) !== -1); // Only include predefined reasons
  
  // Add any remaining reasons (not in predefined list)
  const remainingReasons = Object.entries(consolidatedReasons)
    .filter(([reason]) => getReasonOrderIndex(reason) === -1);
  
  // Combine and sort
  const allReasons = [...sortedReasons, ...remainingReasons];
  
  allReasons.forEach(([reason, count]) => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="reason">${reason}</span>: ${count}`;
    reasonsListEl.appendChild(li);
  });
}

function consolidateReasonSummary(rawSummary) {
  const consolidated = {};
  Object.entries(rawSummary).forEach(([reason, count]) => {
    let normalized = reason.toLowerCase();
    // Special mapping for specific reasons
    if (specialReasonMapping[reason]) {
      consolidated[reason] = (consolidated[reason] || 0) + count;
    } else if (normalized.includes("claw")) {
      consolidated["Clawback"] = (consolidated["Clawback"] || 0) + count;
    } else if (normalized.includes("penalt") || reason.includes("غرامة")) {
      consolidated["Penalty"] = (consolidated["Penalty"] || 0) + count;
    } else {
      consolidated[reason] = (consolidated[reason] || 0) + count;
    }
  });
  return consolidated;
}

function renderTable(data) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  data.forEach(tx => {
    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${tx.referenceId}</td>
      <td>${tx.id}</td>
      <td>${tx.date}</td>
      <td class="${tx.amount < 0 ? 'negative' : ''}">
        ${tx.amount < 0 ? "(" + Math.abs(tx.amount).toFixed(2) + ")" : tx.amount.toFixed(2)}
      </td>
      <td title="Full Description: ${tx.rawDescription}">${tx.description}</td>
      <td>${tx.area}</td>
      <td>${tx.status}</td>
      <td>
        <button onclick="updateStatus('${tx.id}')" ${tx.status === "Compensated" ? 'disabled' : ''}>Mark as Compensated</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderBranchSummary(data) {
  const tbody = document.querySelector("#branchTable tbody");
  tbody.innerHTML = "";

  let branchGroups = {};
  data.forEach(tx => {
    const area = tx.area || "Unknown";
    if (!branchGroups[area]) {
      branchGroups[area] = { count: 0, reasons: new Set(), total: 0 };
    }
    branchGroups[area].count++;
    branchGroups[area].reasons.add(tx.description);
    branchGroups[area].total += Math.abs(tx.amount);
  });

  Object.keys(branchGroups).sort().forEach(area => {
    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${area}</td>
      <td>${branchGroups[area].count}</td>
      <td>${Array.from(branchGroups[area].reasons).join(", ")}</td>
    `;
    tbody.appendChild(row);
  });
}

function renderDeductionsChart(data) {
  const ctx = document.getElementById("deductionsChart").getContext("2d");
  let branchTotals = {};
  data.forEach(tx => {
    const area = tx.area || "Unknown";
    branchTotals[area] = (branchTotals[area] || 0) + Math.abs(tx.amount);
  });

  const labels = Object.keys(branchTotals);
  const amounts = Object.values(branchTotals);

  if (deductionsChart) deductionsChart.destroy();
  deductionsChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Total Deductions by Branch",
        data: amounts,
        backgroundColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0", "#9966FF"],
        borderColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0", "#9966FF"],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Amount (AED)" } },
        x: { title: { display: true, text: "Branch" } }
      }
    }
  });
}

function renderReasonsChart(data) {
  const ctx = document.getElementById("reasonsChart").getContext("2d");
  let reasonSummary = {};
  data.forEach(tx => {
    reasonSummary[tx.description] = (reasonSummary[tx.description] || 0) + 1;
  });
  if (consolidateReasons) {
    reasonSummary = consolidateReasonSummary(reasonSummary);
  }

  // Sort reasons by predefined order for chart
  const sortedReasons = Object.entries(reasonSummary)
    .sort((a, b) => getReasonOrderIndex(a[0]) - getReasonOrderIndex(b[0]))
    .filter(([reason]) => getReasonOrderIndex(reason) !== -1);
  
  const remainingReasons = Object.entries(reasonSummary)
    .filter(([reason]) => getReasonOrderIndex(reason) === -1);
  
  const allReasons = [...sortedReasons, ...remainingReasons];
  
  const labels = allReasons.map(([reason]) => reason);
  const counts = allReasons.map(([, count]) => count);

  if (reasonsChart) reasonsChart.destroy();
  reasonsChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{
        label: "Reasons Distribution",
        data: counts,
        backgroundColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0", "#9966FF"],
        borderColor: ["#fff"],
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: { position: "right" }
      }
    }
  });
}

function applyFilters() {
  const refIdFilter = document.getElementById("filterRefId").value.trim().toLowerCase();
  const idFilter = document.getElementById("filterId").value.trim().toLowerCase();
  const areaFilter = document.getElementById("filterArea").value.trim().toLowerCase();
  const statusFilter = document.getElementById("filterStatus").value;
  const reasonFilter = selectedReason;
  const dateFrom = document.getElementById("filterDateFrom").value;
  const dateTo = document.getElementById("filterDateTo").value;

  const filtered = transactions.filter(tx => {
    const txDate = new Date(tx.date);
    const fromDate = dateFrom ? new Date(dateFrom) : null;
    const toDate = dateTo ? new Date(dateTo) : null;
    
    const matchesReason = reasonFilter === "" || tx.description === reasonFilter;
    
    return (
      (refIdFilter === "" || tx.referenceId.toLowerCase().includes(refIdFilter)) &&
      (idFilter === "" || tx.id.toLowerCase().includes(idFilter)) &&
      (areaFilter === "" || tx.area.toLowerCase().includes(areaFilter)) &&
      (statusFilter === "" || tx.status === statusFilter) &&
      matchesReason &&
      (!fromDate || txDate >= fromDate) &&
      (!toDate || txDate <= toDate)
    );
  });

  renderTable(filtered);
  renderBranchSummary(filtered);
  renderDeductionsChart(filtered);
  renderReasonsChart(filtered);
  updateDashboard(filtered);
}

function clearFilters() {
  document.getElementById("filterRefId").value = "";
  document.getElementById("filterId").value = "";
  document.getElementById("filterArea").value = "";
  document.getElementById("filterStatus").value = "";
  document.getElementById("filterReason").value = "All Reasons";
  selectedReason = "";
  document.getElementById("filterDateFrom").value = "";
  document.getElementById("filterDateTo").value = "";
  
  // Clear reason dropdown selection
  const dropdown = document.getElementById("reasonDropdown");
  dropdown.innerHTML = "";
  populateReasonDropdown();
  
  renderTable(transactions);
  renderBranchSummary(transactions);
  renderDeductionsChart(transactions);
  renderReasonsChart(transactions);
  updateDashboard(transactions);
}

function sortTable(column) {
  if (sortColumn === column) {
    sortAscending = !sortAscending;
  } else {
    sortColumn = column;
    sortAscending = true;
  }

  transactions.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];
    if (column === "amount") {
      return sortAscending ? valA - valB : valB - valA;
    }
    if (column === "date") {
      return sortAscending ? new Date(valA) - new Date(valB) : new Date(valB) - new Date(valA);
    }
    valA = valA.toString().toLowerCase();
    valB = valB.toString().toLowerCase();
    return sortAscending ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });

  renderTable(transactions);
  renderBranchSummary(transactions);
  renderDeductionsChart(transactions);
  renderReasonsChart(transactions);
  updateDashboard(transactions);
}

function updateStatus(id) {
  const tx = transactions.find(t => t.id === id);
  if (tx && tx.status !== "Compensated") {
    tx.status = "Compensated";
    saveData();
    renderTable(transactions);
    renderBranchSummary(transactions);
    renderDeductionsChart(transactions);
    renderReasonsChart(transactions);
    updateDashboard(transactions);
    showNotification(`Status updated to Compensated for ID ${id}`);
  }
}

function toggleReasonConsolidation() {
  consolidateReasons = !consolidateReasons;
  renderTable(transactions);
  renderReasonsChart(transactions);
  updateDashboard(transactions);
  showNotification(`Reasons display set to ${consolidateReasons ? 'consolidated' : 'raw'}.`);
}

function exportToCSV() {
  let csv = "Reference ID,Billable ID,Date,Amount,Description,Merchant Area,Status\n";
  transactions.forEach(tx => {
    csv += `${tx.referenceId},${tx.id},${tx.date},${tx.amount},"${tx.description}",${tx.area},${tx.status}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "clawback_data.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function exportInvalidRecords() {
  let csv = "Line,Original Data,Error Reason,Details\n";
  
  // Add invalid records
  invalidRecords.forEach(record => {
    csv += `${record.line},"${record.data}",${record.reason},"${record.details}"\n`;
  });
  
  // Add duplicate records
  duplicateRecords.forEach(record => {
    csv += `${record.line},"${record.data}",${record.reason},"${record.details}"\n`;
  });
  
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "invalid_records.csv";
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification(`Exported ${invalidRecords.length + duplicateRecords.length} invalid/duplicate records`);
}

function saveData() {
  localStorage.setItem("transactions", JSON.stringify(transactions));
}

function loadData() {
  const saved = localStorage.getItem("transactions");
  if (saved) {
    try {
      transactions = JSON.parse(saved);
      // Generate unique reasons list
      reasonsList = [...new Set(transactions.map(tx => tx.description))];
      reasonsList.sort((a, b) => getReasonOrderIndex(a) - getReasonOrderIndex(b));
      
      // Populate reason dropdown
      populateReasonDropdown();
      
      renderTable(transactions);
      renderBranchSummary(transactions);
      renderDeductionsChart(transactions);
      renderReasonsChart(transactions);
      updateDashboard(transactions);
    } catch (e) {
      showNotification("Error loading saved data.", true);
    }
  }
}

function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
  document.querySelectorAll(".dashboard-card, table, canvas").forEach(el => {
    el.style.background = document.body.classList.contains("dark-mode") ? "#444" : "#fff";
  });
  if (deductionsChart) deductionsChart.update();
  if (reasonsChart) reasonsChart.update();
}

// Report functions
function generateReport() {
  // Calculate report data
  let total = 0;
  let statusSummary = { Refunded: 0, Compensated: 0 };
  let reasonSummary = {};
  let branchSummary = {};

  transactions.forEach(tx => {
    total += tx.amount;
    statusSummary[tx.status] = (statusSummary[tx.status] || 0) + tx.amount;
    reasonSummary[tx.description] = (reasonSummary[tx.description] || 0) + 1;
    
    if (!branchSummary[tx.area]) {
      branchSummary[tx.area] = { total: 0, count: 0 };
    }
    branchSummary[tx.area].total += Math.abs(tx.amount);
    branchSummary[tx.area].count += 1;
  });

  // Update report header date
  const today = new Date();
  const formattedDate = today.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  document.getElementById("reportDate").textContent = `Report Date: ${formattedDate}`;
  document.getElementById("reportFooterDate").textContent = formattedDate;

  // Update executive summary
  document.getElementById("reportTotalRecords").textContent = transactions.length;
  document.getElementById("reportTotalDeductions").textContent = `(${Math.abs(total).toFixed(2)})`;
  document.getElementById("reportAverageRecord").textContent = `(${transactions.length ? Math.abs(total / transactions.length).toFixed(2) : 0})`;
  document.getElementById("reportRefundedAmount").textContent = `(${Math.abs(statusSummary['Refunded'] || 0).toFixed(2)})`;
  document.getElementById("reportCompensatedAmount").textContent = `(${Math.abs(statusSummary['Compensated'] || 0).toFixed(2)})`;

  // Generate top reasons table with special consolidation
  const reasonsList = document.getElementById("topReasonsTable");
  reasonsList.innerHTML = "";
  
  // Apply special consolidation for report
  let reportReasonSummary = {};
  Object.entries(reasonSummary).forEach(([reason, count]) => {
    // Special mapping for specific reasons
    if (specialReasonMapping[reason]) {
      reportReasonSummary[reason] = (reportReasonSummary[reason] || 0) + count;
    } else if (reason.includes("غرامة") || reason.includes("Penalty")) {
      reportReasonSummary["Additional Penalty"] = (reportReasonSummary["Additional Penalty"] || 0) + count;
    } else {
      reportReasonSummary[reason] = (reportReasonSummary[reason] || 0) + count;
    }
  });
  
  // Sort reasons by predefined order for report
  const sortedReasons = Object.entries(reportReasonSummary)
    .sort((a, b) => getReasonOrderIndex(a[0]) - getReasonOrderIndex(b[0]))
    .filter(([reason]) => getReasonOrderIndex(reason) !== -1);
  
  const remainingReasons = Object.entries(reportReasonSummary)
    .filter(([reason]) => getReasonOrderIndex(reason) === -1);
  
  const allReasons = [...sortedReasons, ...remainingReasons];
  
  allReasons.forEach(([reason, count]) => {
    const percentage = ((count / transactions.length) * 100).toFixed(1);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${reason}</td>
      <td>${count}</td>
      <td>${percentage}%</td>
    `;
    reasonsList.appendChild(row);
  });

  // Generate top branches table
  const branchesList = document.getElementById("topBranchesTable");
  branchesList.innerHTML = "";
  
  const sortedBranches = Object.entries(branchSummary)
    .sort((a, b) => b[1].total - a[1].total)
    .slice(0, 5);
  
  const totalBranchDeductions = Object.values(branchSummary).reduce((sum, branch) => sum + branch.total, 0);
  
  sortedBranches.forEach(([branch, data]) => {
    const percentage = ((data.total / totalBranchDeductions) * 100).toFixed(1);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${branch}</td>
      <td>(${data.total.toFixed(2)})</td>
      <td>${percentage}%</td>
    `;
    branchesList.appendChild(row);
  });

  // Generate report charts
  renderReportCharts();

  // Show the report modal
  document.getElementById("reportModal").style.display = "block";
}

function renderReportCharts() {
  // Deductions chart
  const deductionsCtx = document.getElementById("reportDeductionsChart").getContext("2d");
  let branchTotals = {};
  transactions.forEach(tx => {
    const area = tx.area || "Unknown";
    branchTotals[area] = (branchTotals[area] || 0) + Math.abs(tx.amount);
  });

  const labels = Object.keys(branchTotals);
  const amounts = Object.values(branchTotals);

  if (reportDeductionsChart) reportDeductionsChart.destroy();
  reportDeductionsChart = new Chart(deductionsCtx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Total Deductions by Branch",
        data: amounts,
        backgroundColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0", "#9966FF"],
        borderColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0", "#9966FF"],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Amount (AED)" } },
        x: { title: { display: true, text: "Branch" } }
      },
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Reasons chart with special consolidation
  const reasonsCtx = document.getElementById("reportReasonsChart").getContext("2d");
  let reportReasonSummary = {};
  transactions.forEach(tx => {
    // Special mapping for specific reasons
    if (specialReasonMapping[tx.description]) {
      reportReasonSummary[tx.description] = (reportReasonSummary[tx.description] || 0) + 1;
    } else if (tx.description.includes("غرامة") || tx.description.includes("Penalty")) {
      reportReasonSummary["Additional Penalty"] = (reportReasonSummary["Additional Penalty"] || 0) + 1;
    } else {
      reportReasonSummary[tx.description] = (reportReasonSummary[tx.description] || 0) + 1;
    }
  });

  // Sort reasons by predefined order for report chart
  const sortedReasons = Object.entries(reportReasonSummary)
    .sort((a, b) => getReasonOrderIndex(a[0]) - getReasonOrderIndex(b[0]))
    .filter(([reason]) => getReasonOrderIndex(reason) !== -1);
  
  const remainingReasons = Object.entries(reportReasonSummary)
    .filter(([reason]) => getReasonOrderIndex(reason) === -1);
  
  const allReasons = [...sortedReasons, ...remainingReasons];
  
  const reasonLabels = allReasons.map(([reason]) => reason);
  const reasonCounts = allReasons.map(([, count]) => count);

  if (reportReasonsChart) reportReasonsChart.destroy();
  reportReasonsChart = new Chart(reasonsCtx, {
    type: "pie",
    data: {
      labels: reasonLabels,
      datasets: [{
        label: "Reasons Distribution",
        data: reasonCounts,
        backgroundColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0", "#9966FF"],
        borderColor: ["#fff"],
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: { position: "right" }
      },
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

function closeReport() {
  document.getElementById("reportModal").style.display = "none";
}

function printReport() {
  window.print();
}

function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  // Add title
  pdf.setFontSize(20);
  pdf.text('Careem Clawback Management Report', 105, 20, { align: 'center' });
  
  // Add date
  pdf.setFontSize(12);
  const today = new Date().toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  pdf.text(`Report Date: ${today}`, 105, 30, { align: 'center' });
  
  // Add executive summary
  pdf.setFontSize(16);
  pdf.text('Executive Summary', 20, 50);
  
  pdf.setFontSize(12);
  const executiveSummary = [
    `Total Transactions: ${transactions.length}`,
    `Total Deductions: (${Math.abs(transactions.reduce((sum, tx) => sum + tx.amount, 0)).toFixed(2)})`,
    `Average per Transaction: (${transactions.length ? Math.abs(transactions.reduce((sum, tx) => sum + tx.amount, 0) / transactions.length).toFixed(2) : 0})`,
    `Refunded Amount: (${Math.abs(transactions.filter(tx => tx.status === 'Refunded').reduce((sum, tx) => sum + tx.amount, 0)).toFixed(2)})`,
    `Compensated Amount: (${Math.abs(transactions.filter(tx => tx.status === 'Compensated').reduce((sum, tx) => sum + tx.amount, 0)).toFixed(2)})`
  ];
  
  let yPosition = 60;
  executiveSummary.forEach(line => {
    pdf.text(line, 20, yPosition);
    yPosition += 10;
  });
  
  // Add error summary if there are invalid records
  if (invalidRecords.length > 0 || duplicateRecords.length > 0) {
    pdf.setFontSize(16);
    pdf.text('Data Quality Issues', 20, yPosition + 10);
    pdf.setFontSize(12);
    yPosition += 20;
    
    const errorSummary = [
      `Invalid Records: ${invalidRecords.length}`,
      `Duplicate Records: ${duplicateRecords.length}`,
      `Total Issues: ${invalidRecords.length + duplicateRecords.length}`
    ];
    
    errorSummary.forEach(line => {
      pdf.text(line, 30, yPosition);
      yPosition += 10;
    });
    
    yPosition += 10;
  }
  
  // Add top reasons with special consolidation
  pdf.setFontSize(16);
  pdf.text('Top Reasons for Clawbacks', 20, yPosition + 10);
  
  pdf.setFontSize(12);
  yPosition += 20;
  
  let reasonSummary = {};
  transactions.forEach(tx => {
    reasonSummary[tx.description] = (reasonSummary[tx.description] || 0) + 1;
  });
  
  // Apply special consolidation
  let reportReasonSummary = {};
  Object.entries(reasonSummary).forEach(([reason, count]) => {
    if (specialReasonMapping[reason]) {
      reportReasonSummary[reason] = (reportReasonSummary[reason] || 0) + count;
    } else if (reason.includes("غرامة") || reason.includes("Penalty")) {
      reportReasonSummary["Additional Penalty"] = (reportReasonSummary["Additional Penalty"] || 0) + count;
    } else {
      reportReasonSummary[reason] = (reportReasonSummary[reason] || 0) + count;
    }
  });
  
  // Sort reasons by predefined order for PDF
  const sortedReasons = Object.entries(reportReasonSummary)
    .sort((a, b) => getReasonOrderIndex(a[0]) - getReasonOrderIndex(b[0]))
    .filter(([reason]) => getReasonOrderIndex(reason) !== -1);
  
  const remainingReasons = Object.entries(reportReasonSummary)
    .filter(([reason]) => getReasonOrderIndex(reason) === -1);
  
  const allReasons = [...sortedReasons, ...remainingReasons];
  
  allReasons.forEach(([reason, count]) => {
    const percentage = ((count / transactions.length) * 100).toFixed(1);
    pdf.text(`${reason}: ${count} (${percentage}%)`, 30, yPosition);
    yPosition += 10;
  });
  
  // Add top branches
  pdf.setFontSize(16);
  pdf.text('Top Branches by Deduction Amount', 20, yPosition + 10);
  
  pdf.setFontSize(12);
  yPosition += 20;
  
  let branchSummary = {};
  transactions.forEach(tx => {
    if (!branchSummary[tx.area]) {
      branchSummary[tx.area] = { total: 0, count: 0 };
    }
    branchSummary[tx.area].total += Math.abs(tx.amount);
    branchSummary[tx.area].count += 1;
  });
  
  const sortedBranches = Object.entries(branchSummary)
    .sort((a, b) => b[1].total - a[1].total)
    .slice(0, 5);
  
  const totalBranchDeductions = Object.values(branchSummary).reduce((sum, branch) => sum + branch.total, 0);
  
  sortedBranches.forEach(([branch, data]) => {
    const percentage = ((data.total / totalBranchDeductions) * 100).toFixed(1);
    pdf.text(`${branch}: (${data.total.toFixed(2)}) (${percentage}%)`, 30, yPosition);
    yPosition += 10;
  });
  
  // Save the PDF
  pdf.save('clawback_management_report.pdf');
}

window.onload = loadData;
</script>

</body>
</html>
